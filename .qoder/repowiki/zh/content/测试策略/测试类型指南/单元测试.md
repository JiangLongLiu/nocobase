# 单元测试

<cite>
**本文档中引用的文件**  
- [vitest.config.mts](file://vitest.config.mts)
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs)
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts)
- [packages/core/test/src/server/mock-data-source.ts](file://packages/core/test/src/server/mock-data-source.ts)
- [packages/core/test/src/server/mock-isolated-cluster.ts](file://packages/core/test/src/server/mock-isolated-cluster.ts)
- [packages/core/test/setup/server.ts](file://packages/core/test/setup/server.ts)
- [packages/core/test/setup/client.ts](file://packages/core/test/setup/client.ts)
- [packages/core/test/src/index.ts](file://packages/core/test/src/index.ts)
- [packages/core/test/package.json](file://packages/core/test/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [测试配置](#测试配置)
3. [核心测试工具](#核心测试工具)
4. [测试环境隔离](#测试环境隔离)
5. [数据模型测试](#数据模型测试)
6. [服务类测试](#服务类测试)
7. [工具函数测试](#工具函数测试)
8. [测试覆盖率](#测试覆盖率)
9. [性能监控](#性能监控)
10. [CI/CD集成](#cicd集成)

## 简介
NocoBase使用Vitest框架进行单元测试，提供了一套完整的测试工具链来确保核心模块和插件的可靠性。测试框架支持服务器端和客户端两种环境，通过mock-server.ts和mock-data-source.ts等工具实现测试环境的完全隔离，确保测试的独立性和可重复性。

## 测试配置

```mermaid
flowchart TD
A["测试配置入口 vitest.config.mts"] --> B["导入 @nocobase/test/vitest.mjs"]
B --> C["defineConfig()"]
C --> D["公共配置 defineCommonConfig()"]
D --> E["服务器端配置 defineServerConfig()"]
D --> F["客户端配置 defineClientConfig()"]
E --> G["setupFiles: ./setup/server.ts"]
F --> H["setupFiles: ./setup/client.ts"]
D --> I["测试超时时间: 300秒"]
D --> J["测试文件包含模式: __tests__/**/*.test.{ts,tsx}"]
D --> K["覆盖率配置: istanbul"]
```

**图示来源**  
- [vitest.config.mts](file://vitest.config.mts#L1-L4)
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L52-L271)

**本节来源**  
- [vitest.config.mts](file://vitest.config.mts#L1-L4)
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L52-L271)

## 核心测试工具

### MockServer类
MockServer是NocoBase单元测试的核心工具，继承自Application类，提供了完整的应用实例模拟功能。

```mermaid
classDiagram
class MockServer {
+registerMockDataSource()
+loadAndInstall(options)
+cleanDb()
+quickstart(options)
+destroy(options)
+agent(callback)
+createDatabase(options)
}
class Application {
+load(options)
+install(options)
+runCommand(command)
+destroy(options)
}
MockServer --|> Application : 继承
class ExtendedAgent {
+login(user, roleName)
+loginUsingId(userId, roleName)
+resource(name, resourceOf)
}
class Resource {
+get(params)
+list(params)
+create(params)
+update(params)
+destroy(params)
+sort(params)
}
ExtendedAgent --> Resource : 创建
MockServer --> ExtendedAgent : 返回
```

**图示来源**  
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts#L83-L372)

**本节来源**  
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts#L83-L372)

### MockDataSource类
MockDataSource用于模拟数据源连接，确保测试环境与真实数据库隔离。

```mermaid
classDiagram
class MockDataSource {
+static testConnection(options)
+load()
+createCollectionManager(options)
}
class DataSource {
+testConnection(options)
+load()
+createCollectionManager(options)
}
MockDataSource --|> DataSource : 实现
MockDataSource --> CollectionManager : 创建
```

**图示来源**  
- [packages/core/test/src/server/mock-data-source.ts](file://packages/core/test/src/server/mock-data-source.ts#L13-L26)

**本节来源**  
- [packages/core/test/src/server/mock-data-source.ts](file://packages/core/test/src/server/mock-data-source.ts#L13-L26)

## 测试环境隔离

### 服务器端测试设置
服务器端测试通过setup/server.ts文件进行环境初始化。

```mermaid
flowchart TD
A["服务器端测试设置"] --> B["设置环境变量 APP_ENV_PATH"]
B --> C["默认值: .env.test"]
C --> D["调用 initEnv()"]
D --> E["加载测试环境配置"]
E --> F["初始化测试环境"]
```

**图示来源**  
- [packages/core/test/setup/server.ts](file://packages/core/test/setup/server.ts#L1-L6)

**本节来源**  
- [packages/core/test/setup/server.ts](file://packages/core/test/setup/server.ts#L1-L6)

### 客户端测试设置
客户端测试通过setup/client.ts文件进行环境初始化，解决jsdom环境中的各种兼容性问题。

```mermaid
flowchart TD
A["客户端测试设置"] --> B["导入测试库"]
B --> C["@testing-library/jest-dom/vitest"]
B --> D["@testing-library/react"]
A --> E["模拟浏览器API"]
E --> F["window.matchMedia"]
E --> G["window.getComputedStyle"]
E --> H["document.createRange"]
E --> I["URL.createObjectURL"]
E --> J["Worker"]
A --> K["配置测试环境"]
K --> L["异步工具超时: 30秒"]
K --> M["加载 .env.test 环境变量"]
```

**图示来源**  
- [packages/core/test/setup/client.ts](file://packages/core/test/setup/client.ts#L1-L68)

**本节来源**  
- [packages/core/test/setup/client.ts](file://packages/core/test/setup/client.ts#L1-L68)

## 数据模型测试
使用mock-server.ts提供的工具可以轻松测试数据模型，通过agent()方法创建测试代理，执行各种数据操作。

```mermaid
sequenceDiagram
participant Test as 测试用例
participant MockServer as MockServer实例
participant Agent as ExtendedAgent
participant Resource as Resource
participant API as API端点
Test->>MockServer : createMockServer()
MockServer-->>Test : 返回应用实例
Test->>MockServer : agent()
MockServer-->>Agent : 返回代理实例
Test->>Agent : resource('users')
Agent-->>Resource : 返回资源实例
Test->>Resource : create({values : userData})
Resource->>API : POST /users : create
API-->>Resource : 返回响应
Resource-->>Test : 返回supertest.Response
```

**图示来源**  
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts#L125-L214)

**本节来源**  
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts#L125-L214)

## 服务类测试
服务类测试利用MockServer提供的完整应用上下文，可以测试服务间的依赖关系和业务逻辑。

```mermaid
flowchart TD
A["服务类测试流程"] --> B["创建MockServer实例"]
B --> C["加载相关插件"]
C --> D["获取服务实例"]
D --> E["调用服务方法"]
E --> F["验证返回结果"]
F --> G["验证副作用"]
G --> H["清理测试数据"]
```

**本节来源**  
- [packages/core/test/src/server/mock-server.ts](file://packages/core/test/src/server/mock-server.ts#L88-L116)

## 工具函数测试
工具函数测试可以直接导入并测试，无需复杂的设置。

```mermaid
flowchart TD
A["工具函数测试"] --> B["直接导入工具函数"]
B --> C["准备测试数据"]
C --> D["调用工具函数"]
D --> E["断言返回结果"]
E --> F["测试各种边界情况"]
```

**本节来源**  
- [packages/core/test/src/index.ts](file://packages/core/test/src/index.ts#L1-L11)

## 测试覆盖率
NocoBase使用istanbul作为覆盖率提供商，配置了详细的包含和排除规则。

```mermaid
flowchart TD
A["测试覆盖率配置"] --> B["覆盖率提供商: istanbul"]
B --> C["包含路径: packages/**/src/**/*.{ts,tsx}"]
C --> D["排除路径"]
D --> E["**/demos/**"]
D --> F["**/swagger/**"]
D --> G["**/.dumi/**"]
D --> H["**/lib/**"]
D --> I["**/__tests__/**"]
D --> J["**/client.js"]
D --> K["**/server.js"]
D --> L["**/*.d.ts"]
```

**图示来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L86-L102)

**本节来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L86-L102)

## 性能监控
虽然当前代码中没有直接的measure-execution-time.ts文件，但可以通过Vitest的测试超时配置来监控性能。

```mermaid
flowchart TD
A["性能监控配置"] --> B["全局测试超时: 300秒"]
B --> C["钩子函数超时: 300秒"]
C --> D["可配置的重试机制"]
D --> E["CI环境重试2次"]
E --> F["本地环境不重试"]
```

**图示来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L61-L62)

**本节来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L61-L62)

## CI/CD集成
单元测试在CI/CD流程中的执行策略通过环境变量和命令行参数进行控制。

```mermaid
flowchart TD
A["CI/CD执行策略"] --> B["设置TEST_ENV环境变量"]
B --> C["服务器端: server-side"]
C --> D["执行服务器端测试"]
B --> E["客户端: 未设置"]
E --> F["执行客户端测试"]
A --> G["覆盖率报告"]
G --> H["动态生成报告目录"]
H --> I["存储在 storage/coverage/"]
I --> J["按包名组织"]
A --> K["并行测试"]
K --> L["支持过滤测试文件"]
L --> M["指定单个文件或目录"]
M --> N["自动调整包含模式"]
```

**图示来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L229-L270)

**本节来源**  
- [packages/core/test/vitest.mjs](file://packages/core/test/vitest.mjs#L229-L270)