# 插件开发指南

<cite>
**本文档中引用的文件**  
- [create-plugin.js](file://packages/core/cli/src/commands/create-plugin.js)
- [plugin-generator.js](file://packages/core/cli/src/plugin-generator.js)
- [index.js](file://packages/core/cli/src/index.js)
- [index.ts](file://packages/core/cli/templates/plugin/src/index.ts)
- [index.ts.tpl](file://packages/core/cli/templates/plugin/src/server/index.ts.tpl)
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl)
- [index.tsx.tpl](file://packages/core/cli/templates/plugin/src/client/index.tsx.tpl)
- [locale.ts](file://packages/core/cli/templates/plugin/src/client/locale.ts)
- [package.json.tpl](file://packages/core/cli/templates/plugin/package.json.tpl)
- [README.md.tpl](file://packages/core/cli/templates/plugin/README.md.tpl)
</cite>

## 目录
1. [简介](#简介)
2. [使用CLI创建插件](#使用cli创建插件)
3. [插件基本结构](#插件基本结构)
4. [服务器端功能开发](#服务器端功能开发)
5. [客户端功能开发](#客户端功能开发)
6. [依赖注入与服务注册](#依赖注入与服务注册)
7. [插件配置管理](#插件配置管理)
8. [国际化支持](#国际化支持)
9. [完整示例流程](#完整示例流程)

## 简介
NocoBase 是一个基于插件架构的低代码开发平台，允许开发者通过创建插件来扩展系统功能。本指南详细介绍了如何使用 NocoBase 的 CLI 工具创建和开发插件，涵盖从项目初始化到功能实现的完整流程。

## 使用CLI创建插件

NocoBase 提供了命令行工具（CLI）来简化插件的创建过程。通过 `create-plugin` 命令可以快速生成插件的基本结构。

### 命令语法
```bash
npx @nocobase/cli create-plugin <name>
```

其中 `<name>` 是插件的名称，通常采用 `@nocobase/plugin-xxx` 的命名规范。

### 参数选项
- 该命令接受插件名称作为必填参数
- 支持未知选项（allowUnknownOption），允许传递额外的配置参数
- 插件将被创建在 `packages/plugins/<name>` 目录下

### 创建流程
1. CLI 工具调用 `PluginGenerator` 类进行插件生成
2. 检查目标目录是否已存在同名插件
3. 从模板目录复制文件结构
4. 替换模板中的变量（如插件名称、版本号等）
5. 生成 TypeScript 配置路径
6. 执行 `yarn postinstall` 安装依赖

**Section sources**
- [create-plugin.js](file://packages/core/cli/src/commands/create-plugin.js#L18-L33)
- [plugin-generator.js](file://packages/core/cli/src/plugin-generator.js#L39-L80)

## 插件基本结构

NocoBase 插件遵循统一的目录结构，分为服务器端和客户端两个主要部分。

### 文件结构
```
packages/plugins/<plugin-name>/
├── src/
│   ├── server/
│   │   └── plugin.ts
│   ├── client/
│   │   └── index.tsx
│   └── index.ts
├── package.json
├── README.md
└── dist/
```

### 目录作用
- **server 目录**：存放服务器端逻辑，包括 API 端点、数据模型和业务逻辑
- **client 目录**：存放客户端逻辑，包括 UI 组件、页面和路由
- **index.ts**：插件的入口文件，导出服务器端和客户端的主类

### 入口文件实现
入口文件 `src/index.ts` 采用以下标准实现：
```typescript
export * from './server';
export { default } from './server';
```

这确保了插件可以被正确导入和使用。

**Section sources**
- [index.ts](file://packages/core/cli/templates/plugin/src/index.ts#L1-L3)
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl#L1-L20)
- [index.tsx.tpl](file://packages/core/cli/templates/plugin/src/client/index.tsx.tpl#L1-L22)

## 服务器端功能开发

服务器端插件通过继承 `Plugin` 类来实现各种生命周期方法和功能扩展。

### 核心生命周期方法
```typescript
export class PluginNameServer extends Plugin {
  async afterAdd() {}
  async beforeLoad() {}
  async load() {}
  async install() {}
  async afterEnable() {}
  async afterDisable() {}
  async remove() {}
}
```

### API端点定义
在 `load()` 方法中可以通过以下方式定义新的 API 端点：
- 使用 `this.app.resourcer` 注册资源
- 使用 `this.app.router` 添加自定义路由
- 定义控制器类来处理特定的业务逻辑

### 数据模型定义
通过 `this.db.collection()` 方法可以定义新的数据模型：
```typescript
this.db.collection({
  name: 'modelName',
  fields: [
    { type: 'string', name: 'title' },
    { type: 'text', name: 'description' }
  ]
});
```

### 业务逻辑实现
业务逻辑可以在插件类的方法中实现，也可以通过服务类来组织：
- 在 `install()` 方法中初始化数据
- 在 `load()` 方法中注册事件监听器
- 实现自定义的业务服务类

**Section sources**
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl#L1-L20)
- [plugin-generator.js](file://packages/core/cli/src/plugin-generator.js#L47-L58)

## 客户端功能开发

客户端插件同样继承 `Plugin` 类，用于扩展用户界面和交互功能。

### UI组件添加
在 `load()` 方法中可以通过以下方式添加 UI 组件：
- 使用 `this.app.addComponents()` 注册新组件
- 使用 `this.app.addScopes()` 添加作用域
- 使用 `this.app.addProvider()` 添加 React Provider

### 页面和路由
通过 `this.app.router.add()` 方法可以添加新的路由：
```typescript
this.app.router.add('route-name', '/path', Component);
```

### 客户端生命周期
客户端插件也支持类似的生命周期方法：
- `afterAdd()`：插件添加后调用
- `beforeLoad()`：加载前调用
- `load()`：主要的客户端逻辑实现位置

**Section sources**
- [index.tsx.tpl](file://packages/core/cli/templates/plugin/src/client/index.tsx.tpl#L1-L22)
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl#L1-L20)

## 依赖注入与服务注册

NocoBase 采用依赖注入机制来管理插件和服务之间的依赖关系。

### 服务注册
插件可以通过以下方式注册服务：
- 在服务器端使用 `this.app.service()` 注册服务
- 在客户端使用 `this.app.addProvider()` 注册 React 服务

### 依赖获取
插件可以通过以下方式获取其他服务：
- 使用 `this.app.getPlugin()` 获取其他插件实例
- 使用 `this.app.db` 获取数据库实例
- 使用 `this.app.resourcer` 获取资源管理器

### 服务发现
NocoBase 的插件管理系统支持服务发现机制：
- 插件可以通过名称查找和使用其他插件提供的服务
- 支持插件间的事件通信和数据共享

**Section sources**
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl#L1-L20)
- [index.tsx.tpl](file://packages/core/cli/templates/plugin/src/client/index.tsx.tpl#L1-L22)

## 插件配置管理

插件的配置管理遵循 NocoBase 的统一配置规范。

### 配置文件
每个插件都有自己的 `package.json` 文件，其中包含：
- 插件名称和版本
- 主入口文件路径
- 依赖和对等依赖

### 配置最佳实践
- 使用语义化版本号
- 正确声明对 NocoBase 核心包的对等依赖
- 在 `peerDependencies` 中声明所需的 NocoBase 版本

### 环境配置
插件可以通过环境变量进行配置：
- 使用 `.env` 文件管理环境特定的配置
- 在代码中通过 `process.env` 访问环境变量

**Section sources**
- [package.json.tpl](file://packages/core/cli/templates/plugin/package.json.tpl#L1-L12)
- [plugin-generator.js](file://packages/core/cli/src/plugin-generator.js#L47-L58)

## 国际化支持

NocoBase 提供了完整的国际化支持，插件可以轻松实现多语言功能。

### 国际化文件
插件可以通过 `locale.ts` 文件实现国际化：
```typescript
export function useT() {
  const app = useApp();
  return (str: string) => app.i18n.t(str, { ns: [pkg.name, 'client'] });
}
```

### 翻译函数
提供了两个主要的翻译函数：
- `useT()`：React Hook 形式的翻译函数
- `tStr()`：字符串模板形式的翻译函数

### 多语言支持
- 支持命名空间（namespace）机制
- 可以在不同语言文件中定义翻译文本
- 自动根据用户语言偏好加载相应的语言包

**Section sources**
- [locale.ts](file://packages/core/cli/templates/plugin/src/client/locale.ts#L1-L13)
- [package.json.tpl](file://packages/core/cli/templates/plugin/package.json.tpl#L1-L12)

## 完整示例流程

以下是从创建到实现的完整插件开发流程：

1. **创建插件**
   ```bash
   npx @nocobase/cli create-plugin @nocobase/plugin-hello-world
   ```

2. **实现服务器端功能**
   - 在 `src/server/plugin.ts` 中定义插件类
   - 在 `load()` 方法中添加 API 端点和数据模型

3. **实现客户端功能**
   - 在 `src/client/index.tsx` 中定义客户端插件类
   - 在 `load()` 方法中添加 UI 组件和路由

4. **添加国际化支持**
   - 使用 `useT()` 函数实现文本翻译
   - 在语言文件中添加相应的翻译文本

5. **配置和打包**
   - 更新 `package.json` 中的元数据
   - 构建插件并测试功能

6. **安装和启用**
   - 在 NocoBase 应用中安装插件
   - 通过管理界面启用插件

此流程展示了从零开始创建一个功能完整的 NocoBase 插件的全过程。

**Section sources**
- [create-plugin.js](file://packages/core/cli/src/commands/create-plugin.js#L18-L33)
- [plugin-generator.js](file://packages/core/cli/src/plugin-generator.js#L39-L80)
- [plugin.ts.tpl](file://packages/core/cli/templates/plugin/src/server/plugin.ts.tpl#L1-L20)
- [index.tsx.tpl](file://packages/core/cli/templates/plugin/src/client/index.tsx.tpl#L1-L22)