# 安全考虑

<cite>
**本文档中引用的文件**  
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts)
- [jwt-service.ts](file://packages/core/auth/src/base/jwt-service.ts)
- [token-blacklist-service.ts](file://packages/core/auth/src/base/token-blacklist-service.ts)
- [storer.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/storer.ts)
- [acl.ts](file://packages/core/acl/src/acl.ts)
- [allow-manager.ts](file://packages/core/acl/src/allow-manager.ts)
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts)
- [index.ts](file://packages/core/server/src/audit-manager/index.ts)
</cite>

## 目录
1. [引言](#引言)
2. [多层次安全架构](#多层次安全架构)
3. [JWT认证实现](#jwt认证实现)
4. [访问控制列表（ACL）系统](#访问控制列表acl系统)
5. [数据级别安全控制](#数据级别安全控制)
6. [安全最佳实践](#安全最佳实践)
7. [安全审计日志](#安全审计日志)
8. [合规性要求](#合规性要求)

## 引言

NocoBase平台提供了一套全面的安全机制，确保应用程序在认证、授权和审计方面的安全性。本文档详细解释了NocoBase的多层次安全架构，包括JWT认证的实现细节、访问控制列表（ACL）系统的权限模型、数据级别的安全控制，以及安全审计日志的配置和使用方法。

## 多层次安全架构

NocoBase的安全架构由多个组件协同工作，包括认证管理器、访问控制列表（ACL）系统和审计管理器。这些组件共同确保系统的安全性。

```mermaid
graph TB
subgraph "认证层"
AuthManager[认证管理器]
JWT[JWT服务]
TokenBlacklist[令牌黑名单服务]
end
subgraph "授权层"
ACL[访问控制列表]
RoleManager[角色管理器]
SnippetManager[片段管理器]
end
subgraph "审计层"
AuditManager[审计管理器]
AuditLogs[审计日志]
end
AuthManager --> ACL
JWT --> AuthManager
TokenBlacklist --> JWT
RoleManager --> ACL
SnippetManager --> ACL
AuditManager --> AuditLogs
AuthManager --> AuditManager
ACL --> AuditManager
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts)
- [acl.ts](file://packages/core/acl/src/acl.ts)
- [index.ts](file://packages/core/server/src/audit-manager/index.ts)

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L42-L173)
- [acl.ts](file://packages/core/acl/src/acl.ts#L66-L603)
- [index.ts](file://packages/core/server/src/audit-manager/index.ts#L266-L306)

## JWT认证实现

NocoBase使用JWT（JSON Web Token）进行用户认证，确保安全的令牌生成、验证和刷新流程。

### 令牌生成与验证

JWT服务负责生成和验证令牌，使用HMAC SHA256算法进行签名，确保令牌的安全性。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthManager as "认证管理器"
participant JWTService as "JWT服务"
Client->>AuthManager : 登录请求
AuthManager->>JWTService : 生成JWT令牌
JWTService-->>AuthManager : 返回签名令牌
AuthManager-->>Client : 返回JWT令牌
Client->>AuthManager : 带JWT的API请求
AuthManager->>JWTService : 验证JWT令牌
JWTService-->>AuthManager : 返回解码的用户信息
AuthManager-->>Client : 处理请求
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L46-L61)
- [jwt-service.ts](file://packages/core/auth/src/base/jwt-service.ts#L20-L78)

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L54-L61)
- [jwt-service.ts](file://packages/core/auth/src/base/jwt-service.ts#L20-L78)

### JWT密钥管理

NocoBase采用多层密钥管理策略，确保JWT密钥的安全性。

```mermaid
flowchart TD
Start([启动应用]) --> CheckFile["检查jwt_secret.dat文件"]
CheckFile --> FileExists{"文件存在?"}
FileExists --> |是| ReadFile["读取32字节密钥"]
FileExists --> |否| CheckEnv["检查APP_KEY环境变量"]
CheckEnv --> EnvExists{"环境变量存在?"}
EnvExists --> |是| UseEnv["使用环境变量密钥"]
EnvExists --> |否| GenerateRandom["生成32字节随机密钥"]
GenerateRandom --> SaveFile["保存到jwt_secret.dat"]
SaveFile --> UseKey["使用生成的密钥"]
ReadFile --> UseKey
UseEnv --> UseKey
UseKey --> End([完成密钥设置])
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L154-L172)

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L154-L172)

## 访问控制列表（ACL）系统

NocoBase的ACL系统提供了灵活的权限管理机制，支持基于角色的访问控制和细粒度的权限策略。

### 权限模型

ACL系统通过角色、策略和权限检查实现复杂的访问控制逻辑。

```mermaid
classDiagram
class ACL {
+roles Map[string, ACLRole]
+availableActions Map[string, ACLAvailableAction]
+availableStrategy Map[string, ACLAvailableStrategy]
+allowManager AllowManager
+snippetManager SnippetManager
+can(options CanArgs) CanResult
+define(options DefineOptions) ACLRole
+getRole(name string) ACLRole
}
class ACLRole {
+name string
+strategy string | AvailableStrategyOptions
+resources Map[string, ACLResource]
+snippetAllowed(actionPath string) boolean
+grantAction(path string, options RoleActionParams) void
+getResource(name string) ACLResource
}
class ACLResource {
+name string
+role ACLRole
+actions Map[string, RoleActionParams]
+setAction(actionName string, options RoleActionParams) void
+getAction(actionName string) RoleActionParams
}
class AllowManager {
+skipActions Map[string, Map[string, string | ConditionFunc | true]]
+registeredCondition Map[string, ConditionFunc>
+isAllowed(resourceName string, actionName string, ctx any) boolean
+allow(resourceName string, actionName string, condition string | ConditionFunc) void
}
class SnippetManager {
+snippets Map[string, SnippetOptions]
+register(snippet SnippetOptions) void
+getSnippet(name string) SnippetOptions
}
ACL --> ACLRole : "包含"
ACL --> AllowManager : "使用"
ACL --> SnippetManager : "使用"
ACLRole --> ACLResource : "包含"
ACLRole --> ACLAvailableStrategy : "引用"
```

**Diagram sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L66-L603)
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts#L49-L98)
- [allow-manager.ts](file://packages/core/acl/src/allow-manager.ts#L14-L112)

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L66-L603)
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts#L49-L98)

### 角色管理

NocoBase支持灵活的角色管理，允许管理员定义不同角色的权限。

```mermaid
flowchart TD
Start([创建角色]) --> DefineRole["定义角色名称和策略"]
DefineRole --> SetActions["设置资源操作权限"]
SetActions --> AddSnippets["添加权限片段"]
AddSnippets --> ConfigureStrategy["配置策略(own, all等)"]
ConfigureStrategy --> SaveRole["保存角色配置"]
SaveRole --> End([角色创建完成])
subgraph "权限检查流程"
CheckStart([API请求]) --> GetRole["获取用户角色"]
GetRole --> FindRole["在ACL中查找角色"]
FindRole --> CheckSnippet["检查权限片段"]
CheckSnippet --> CheckResource["检查资源权限"]
CheckResource --> CheckStrategy["检查策略权限"]
CheckStrategy --> Allow["允许访问"]
CheckStrategy --> Deny["拒绝访问"]
end
```

**Diagram sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts#L72-L523)
- [acl.ts](file://packages/core/acl/src/acl.ts#L151-L168)

**Section sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts#L72-L523)
- [acl.ts](file://packages/core/acl/src/acl.ts#L151-L168)

## 数据级别安全控制

NocoBase提供行级和字段级的安全控制，确保数据访问的精确性。

### 行级权限

通过过滤器实现行级权限控制，限制用户只能访问特定记录。

```mermaid
flowchart TD
Request([API请求]) --> CheckPermission["检查用户权限"]
CheckPermission --> HasPermission{"有权限?"}
HasPermission --> |是| ApplyFilter["应用行级过滤器"]
HasPermission --> |否| DenyAccess["拒绝访问"]
ApplyFilter --> AddConditions["添加createdById = currentUser.id"]
AddConditions --> ExecuteQuery["执行数据库查询"]
ExecuteQuery --> ReturnResults["返回结果"]
DenyAccess --> ReturnError["返回403错误"]
```

**Diagram sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L467-L493)

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L467-L493)

### 字段级权限

通过白名单机制实现字段级权限控制，限制用户只能访问特定字段。

```mermaid
flowchart TD
Request([API请求]) --> CheckFields["检查请求字段"]
CheckFields --> GetAllowedFields["获取允许的字段列表"]
GetAllowedFields --> FilterFields["过滤字段"]
FilterFields --> RemoveDisallowed["移除不允许的字段"]
RemoveDisallowed --> ExecuteQuery["执行查询"]
ExecuteQuery --> ReturnResults["返回结果"]
subgraph "字段权限配置"
DefineFields["定义字段权限"]
--> Whitelist["设置白名单字段"]
--> SaveConfig["保存配置"]
end
```

**Diagram sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L517-L557)

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L517-L557)

## 安全最佳实践

NocoBase遵循多项安全最佳实践，防止常见攻击并确保系统安全。

### 密码策略

实施严格的密码策略，确保用户账户安全。

```mermaid
flowchart TD
Register([用户注册]) --> ValidatePassword["验证密码强度"]
ValidatePassword --> StrongEnough{"足够强?"}
StrongEnough --> |是| HashPassword["使用bcrypt哈希密码"]
StrongEnough --> |否| RejectPassword["拒绝弱密码"]
HashPassword --> StoreHash["存储密码哈希"]
StoreHash --> CompleteRegistration["完成注册"]
```

**Section sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L75-L93)

### 会话管理

采用安全的会话管理机制，防止会话劫持和固定攻击。

```mermaid
flowchart TD
Login([用户登录]) --> GenerateToken["生成JWT令牌"]
GenerateToken --> SetExpiry["设置7天过期时间"]
SetExpiry --> SignToken["使用密钥签名"]
SignToken --> ReturnToken["返回令牌"]
ReturnToken --> StoreInBlacklist["可选:存储在黑名单"]
APIRequest([API请求]) --> ExtractToken["提取JWT令牌"]
ExtractToken --> VerifySignature["验证签名"]
VerifySignature --> CheckBlacklist["检查黑名单"]
CheckBlacklist --> Valid{"有效?"}
Valid --> |是| ProcessRequest["处理请求"]
Valid --> |否| ReturnError["返回401错误"]
```

**Diagram sources**
- [jwt-service.ts](file://packages/core/auth/src/base/jwt-service.ts#L20-L78)
- [token-blacklist-service.ts](file://packages/core/auth/src/base/token-blacklist-service.ts#L10-L13)

**Section sources**
- [jwt-service.ts](file://packages/core/auth/src/base/jwt-service.ts#L20-L78)
- [token-blacklist-service.ts](file://packages/core/auth/src/base/token-blacklist-service.ts#L10-L13)

### 防止常见攻击

实施多项措施防止CSRF、XSS等常见攻击。

```mermaid
flowchart TD
subgraph "CSRF防护"
CSRFStart([表单提交]) --> CheckToken["验证CSRF令牌"]
CheckToken --> ValidToken{"令牌有效?"}
ValidToken --> |是| ProcessForm["处理表单"]
ValidToken --> |否| RejectForm["拒绝提交"]
end
subgraph "XSS防护"
XSSStart([用户输入]) --> SanitizeInput["清理HTML内容"]
SanitizeInput --> EscapeOutput["转义输出内容"]
EscapeOutput --> DisplaySafe["安全显示"]
end
subgraph "速率限制"
RateStart([API请求]) --> CheckRate["检查请求频率"]
CheckRate --> WithinLimit{"在限制内?"}
WithinLimit --> |是| ProcessRequest["处理请求"]
WithinLimit --> |否| Throttle["限流或拒绝"]
end
```

**Section sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L36-L38)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts#L505-L523)

## 安全审计日志

NocoBase提供全面的审计日志功能，记录所有关键操作。

### 审计日志结构

审计日志记录了操作的详细信息，包括用户、角色、IP地址和操作结果。

```mermaid
erDiagram
AUDIT_LOGS {
uuid id PK
string resource
string action
integer userId FK
string roleName
string ip
string ua
integer status
datetime createdAt
json metadata
}
USERS {
integer id PK
string username
string email
}
ROLES {
string name PK
string title
}
AUDIT_LOGS ||--o{ USERS : "由用户执行"
AUDIT_LOGS ||--o{ ROLES : "在角色下执行"
```

**Diagram sources**
- [index.ts](file://packages/core/server/src/audit-manager/index.ts#L266-L306)

**Section sources**
- [index.ts](file://packages/core/server/src/audit-manager/index.ts#L266-L306)

### 审计日志配置

审计日志可以针对不同操作进行精细配置。

```mermaid
flowchart TD
subgraph "审计配置"
DefineActions["定义审计操作"]
--> SetMetadata["设置元数据收集"]
--> ConfigureUserInfo["配置用户信息"]
--> SaveConfig["保存配置"]
end
subgraph "审计记录流程"
ActionStart([执行操作]) --> CheckAudit["检查是否需要审计"]
CheckAudit --> NeedAudit{"需要审计?"}
NeedAudit --> |是| CollectData["收集审计数据"]
NeedAudit --> |否| SkipAudit["跳过审计"]
CollectData --> FormatLog["格式化日志"]
FormatLog --> StoreLog["存储日志"]
end
```

**Section sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L238-L272)
- [index.ts](file://packages/core/server/src/audit-manager/index.ts#L277-L306)

## 合规性要求

NocoBase设计符合多项合规性要求，确保数据安全和隐私保护。

### 数据保护

实施严格的数据保护措施，符合GDPR等法规要求。

```mermaid
flowchart TD
subgraph "数据保护措施"
Encryption["数据加密存储"]
AccessControl["严格的访问控制"]
AuditTrail["完整的审计跟踪"]
DataRetention["数据保留策略"]
Anonymization["数据匿名化"]
end
Compliance([合规性要求]) --> GDPR["GDPR"]
Compliance --> CCPA["CCPA"]
Compliance --> HIPAA["HIPAA"]
GDPR --> |要求| Encryption
GDPR --> |要求| AccessControl
GDPR --> |要求| AuditTrail
CCPA --> |要求| DataRetention
HIPAA --> |要求| Encryption
HIPAA --> |要求| AccessControl
```

**Section sources**
- [plugin.ts](file://packages/plugins/@nocobase/plugin-audit-logs/src/client/deplicated/AuditLogs.tsx#L210-L524)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L238-L272)