# 外部认证集成

<cite>
**本文档中引用的文件**  
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts)
- [storer.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/storer.ts)
- [basic-auth.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/basic-auth.ts)
- [authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/actions/authenticators.ts)
- [collections/authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/authenticators.ts)
- [collections/users-authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/users-authenticators.ts)
- [preset.ts](file://packages/plugins/@nocobase/plugin-auth/src/preset.ts)
- [users-verifiers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/users-verifiers.ts)
- [verifications_providers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/verifications_providers.ts)
</cite>

## 目录
1. [简介](#简介)
2. [认证管理器架构](#认证管理器架构)
3. [外部认证协议集成](#外部认证协议集成)
4. [认证流程详解](#认证流程详解)
5. [多因素认证支持](#多因素认证支持)
6. [配置管理](#配置管理)
7. [安全考虑](#安全考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

NocoBase 提供了灵活的外部认证集成机制，支持多种认证协议如 OAuth2、LDAP、SAML 等。系统通过认证管理器（AuthManager）统一管理不同的认证策略，实现了可扩展的认证架构。本文档将深入探讨 NocoBase 的外部认证集成机制，包括认证流程、令牌交换、用户信息映射、多因素认证场景处理以及安全考虑等方面。

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L42-L174)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L24-L324)

## 认证管理器架构

NocoBase 的认证管理器（AuthManager）是外部认证系统的核心组件，负责注册、管理和执行各种认证策略。认证管理器通过插件化架构实现了高度的可扩展性。

```mermaid
classDiagram
class AuthManager {
+jwt : JwtService
+tokenController : ITokenControlService
-options : AuthManagerOptions
-authTypes : Registry~AuthConfig~
-storer : Storer
+registerTypes(authType : string, authConfig : AuthConfig)
+listTypes()
+getAuthConfig(authType : string)
+get(name : string, ctx : Context)
+middleware()
}
class Storer {
+db : Database
+cache : Cache
+app : Application
+authManager : AuthManager
+key = 'authenticators'
+get(name : string)
+getCache()
+setCache(authenticators : AuthModel[])
+renderJsonTemplate(authenticator : any)
}
class AuthConfig {
+auth : AuthExtend~Auth~
+title? : string
+getPublicOptions? : (options : Record~string, any~) => Record~string, any~
}
AuthManager --> Storer : "使用"
AuthManager --> AuthConfig : "管理"
Storer --> "authenticators" : "数据存储"
Storer --> "Cache" : "缓存"
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L42-L174)
- [storer.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/storer.ts#L16-L93)

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L42-L174)
- [storer.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/storer.ts#L16-L93)

## 外部认证协议集成

NocoBase 通过认证类型注册机制支持多种外部认证协议。系统预设了基本认证（Email/Password），并可通过插件扩展支持 OAuth2、LDAP、SAML 等协议。

### 认证类型注册

认证管理器通过 `registerTypes` 方法注册新的认证类型，每个认证类型都有唯一的名称和相应的配置。

```mermaid
sequenceDiagram
participant Plugin as "认证插件"
participant AuthManager as "认证管理器"
participant Storer as "存储器"
participant DB as "数据库"
Plugin->>AuthManager : registerTypes("OAuth2", config)
AuthManager->>AuthManager : 将认证类型注册到authTypes注册表
Plugin->>AuthManager : setStorer(Storer实例)
AuthManager->>Storer : 初始化存储器
Storer->>DB : 监听authenticators表的变更
DB-->>Storer : 触发afterSave/afterDestroy事件
Storer->>Storer : 更新缓存中的认证器信息
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L83-L85)
- [plugin.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/plugin.ts#L75-L111)
- [storer.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/storer.ts#L39-L48)

### 用户信息映射

外部认证系统通过 `users-authenticators` 表实现用户信息映射，将外部认证标识与内部用户账户关联。

```mermaid
erDiagram
USERS {
uuid id PK
string username
string email
string password
timestamp createdAt
timestamp updatedAt
}
AUTHENTICATORS {
string name PK
string authType
string title
json options
boolean enabled
integer sort
}
USERS_AUTHENTICATORS {
uuid id PK
string authenticatorName FK
integer userId FK
string uid
string nickname
string avatar
json meta
}
USERS ||--o{ USERS_AUTHENTICATORS : "拥有"
AUTHENTICATORS ||--o{ USERS_AUTHENTICATORS : "关联"
```

**Diagram sources**
- [collections/authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/authenticators.ts#L15-L57)
- [collections/users-authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/users-authenticators.ts#L1-L78)

**Section sources**
- [collections/authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/authenticators.ts#L15-L57)
- [collections/users-authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/users-authenticators.ts#L1-L78)

## 认证流程详解

NocoBase 的外部认证流程包括重定向、令牌交换和用户信息获取等关键步骤。

### OAuth2 认证流程

```mermaid
sequenceDiagram
participant User as "用户"
participant Frontend as "前端应用"
participant Backend as "后端服务"
participant OAuth2Provider as "OAuth2提供者"
User->>Frontend : 点击"使用Google登录"
Frontend->>Backend : 请求可用的认证器列表
Backend->>Frontend : 返回启用的认证器信息
Frontend->>User : 显示认证选项
User->>Frontend : 选择Google认证
Frontend->>Backend : 发起认证请求
Backend->>OAuth2Provider : 重定向到授权服务器
OAuth2Provider->>User : 显示授权页面
User->>OAuth2Provider : 授权应用访问
OAuth2Provider->>Backend : 重定向回回调URL并携带授权码
Backend->>OAuth2Provider : 交换授权码获取访问令牌
OAuth2Provider->>Backend : 返回访问令牌和用户信息
Backend->>Backend : 创建或更新用户账户
Backend->>Backend : 生成JWT令牌
Backend->>Frontend : 返回用户信息和JWT令牌
Frontend->>User : 登录成功，进入应用
```

**Diagram sources**
- [authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/actions/authenticators.ts#L31-L55)
- [basic-auth.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/basic-auth.ts#L16-L361)

### 令牌交换与验证

认证管理器使用 JWT（JSON Web Token）进行安全的令牌交换和验证。

```mermaid
flowchart TD
A[客户端请求] --> B{包含Bearer Token?}
B --> |是| C[提取JWT令牌]
B --> |否| D[返回401未授权]
C --> E[解码JWT令牌]
E --> F{令牌有效?}
F --> |否| G[返回401无效令牌]
F --> |是| H[检查令牌是否在黑名单]
H --> I{在黑名单?}
I --> |是| J[返回401已撤销令牌]
I --> |否| K[检查用户是否存在]
K --> L{用户存在?}
L --> |否| M[返回401用户不存在]
L --> |是| N[检查会话是否过期]
N --> O{会期过期?}
O --> |是| P[返回401会话过期]
O --> |否| Q[验证通过，继续处理请求]
```

**Diagram sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L123-L152)
- [base\auth.ts](file://packages/core/auth/src/base/auth.ts#L73-L204)

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L123-L152)
- [base\auth.ts](file://packages/core/auth/src/base/auth.ts#L73-L204)

## 多因素认证支持

NocoBase 通过验证管理插件（plugin-verification）支持多因素认证场景，包括短信验证码、邮箱验证等。

### 多因素认证架构

```mermaid
classDiagram
class VerificationProvider {
+id : string
+title : string
+type : string
+options : json
+default : boolean
}
class Verificator {
+name : string
+provider : string
+settings : json
}
class UserVerifier {
+uuid : string
+meta : json
}
class Authenticator {
+name : string
+authType : string
+options : json
+enabled : boolean
}
VerificationProvider --> Verificator : "创建"
Verificator --> UserVerifier : "验证"
Authenticator --> Verificator : "使用"
```

**Diagram sources**
- [verifications_providers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/verifications_providers.ts#L12-L42)
- [users-verifiers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/users-verifiers.ts#L16-L41)

**Section sources**
- [verifications_providers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/verifications_providers.ts#L12-L42)
- [users-verifiers.ts](file://packages/plugins/@nocobase/plugin-verification/src/server/collections/users-verifiers.ts#L16-L41)

## 配置管理

外部认证的配置通过数据库和环境变量进行管理，支持动态配置更新。

### 配置结构

```mermaid
flowchart TD
A[认证配置] --> B[基础配置]
A --> C[公共配置]
A --> D[环境变量配置]
B --> B1[name: 认证器名称]
B --> B2[authType: 认证类型]
B --> B3[title: 显示标题]
B --> B4[enabled: 是否启用]
B --> B5[sort: 排序]
C --> C1[allowSignUp: 允许注册]
C --> C2[signupForm: 注册表单配置]
C --> C3[enableResetPassword: 允许重置密码]
D --> D1[CLIENT_ID: 客户端ID]
D --> D2[CLIENT_SECRET: 客户端密钥]
D --> D3[AUTHORIZATION_URL: 授权服务器地址]
D --> D4[TOKEN_URL: 令牌端点]
D --> D5[USER_INFO_URL: 用户信息端点]
```

**Section sources**
- [authenticators.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/collections/authenticators.ts#L27-L57)
- [basic-auth.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/basic-auth.ts#L117-L139)

## 安全考虑

NocoBase 在外部认证集成中实施了多项安全措施，确保系统的安全性。

### 安全机制

```mermaid
flowchart TD
A[安全机制] --> B[CSRF防护]
A --> C[令牌劫持防护]
A --> D[信任链管理]
A --> E[输入验证]
A --> F[日志审计]
B --> B1[使用安全的会话管理]
B --> B2[验证请求来源]
C --> C1[使用HTTPS传输]
C --> C2[令牌有效期控制]
C --> C3[令牌黑名单机制]
D --> D1[验证提供者证书]
D --> D2[检查令牌签名]
D --> D3[验证令牌颁发者]
E --> E1[验证用户名格式]
E --> E2[密码强度检查]
E --> E3[防止SQL注入]
F --> F1[记录登录尝试]
F --> F2[记录失败认证]
F --> F3[记录令牌操作]
```

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L67-L69)
- [base\auth.ts](file://packages/core/auth/src/base/auth.ts#L132-L138)
- [basic-auth.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/basic-auth.ts#L24-L38)

## 故障排除指南

### 常见问题及解决方案

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 令牌无效 | 令牌过期或被撤销 | 检查令牌有效期，重新登录获取新令牌 |
| 用户映射失败 | 外部标识与内部用户不匹配 | 检查users-authenticators表中的映射关系 |
| 认证重定向失败 | 回调URL配置错误 | 验证OAuth2配置中的回调URL是否正确 |
| 无法获取用户信息 | 权限不足或API端点变更 | 检查OAuth2作用域权限，验证API端点 |
| 多因素认证不工作 | 验证提供者配置错误 | 检查verifications_providers表中的配置 |

**Section sources**
- [auth-manager.ts](file://packages/core/auth/src/auth-manager.ts#L104-L117)
- [basic-auth.ts](file://packages/plugins/@nocobase/plugin-auth/src/server/basic-auth.ts#L44-L47)

## 结论

NocoBase 的外部认证集成提供了灵活、安全且可扩展的认证机制。通过认证管理器架构，系统能够轻松集成多种认证协议，支持复杂的认证场景。文档详细介绍了认证流程、配置管理、安全考虑和故障排除等方面，为开发者提供了全面的指导。未来可以通过扩展更多认证插件来支持更多的身份提供商，进一步增强系统的认证能力。