# 授权机制

<cite>
**本文档引用的文件**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [acl-resource.ts](file://packages\core\acl\src\acl-resource.ts)
- [acl-available-strategy.ts](file://packages\core\acl\src\acl-available-strategy.ts)
- [fixed-params-manager.ts](file://packages\core\acl\src\fixed-params-manager.ts)
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)
- [allow-manager.ts](file://packages\core\acl\src\allow-manager.ts)
- [server.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\server.ts)
- [check-association-operate.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\middlewares\check-association-operate.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [权限验证流程](#权限验证流程)
4. [角色与权限关联机制](#角色与权限关联机制)
5. [权限配置说明](#权限配置说明)
6. [细粒度访问控制](#细粒度访问控制)

## 简介
NocoBase的授权机制基于ACL（访问控制列表）系统，提供了一套完整的权限管理解决方案。该系统通过角色定义、权限策略、资源访问控制和权限继承机制来实现灵活的权限管理。系统支持固定权限和动态权限的实现方式，允许开发者根据业务需求进行细粒度的访问控制。

**本节不分析具体源文件**

## 核心组件

NocoBase的ACL系统由多个核心组件构成，包括ACL、ACLRole、ACLResource、ACLAvaliableStrategy等。这些组件共同协作，实现了完整的权限管理体系。

```mermaid
classDiagram
class ACL {
+roles Map[string, ACLRole]
+availableActions Map[string, ACLAvailableAction]
+availableStrategy Map[string, ACLAvailableStrategy]
+snippetManager SnippetManager
+fixedParamsManager FixedParamsManager
+allowManager AllowManager
+define(options) ACLRole
+getRole(name) ACLRole
+can(options) CanResult
+middleware() Function
}
class ACLRole {
+name string
+strategy string | AvailableStrategyOptions
+resources Map[string, ACLResource]
+snippets Set[string]
+grantAction(path, options) void
+getResource(name) ACLResource
+getStrategy() ACLAvailableStrategy
+snippetAllowed(actionPath) boolean
}
class ACLResource {
+name string
+role ACLRole
+actions Map[string, RoleActionParams]
+setAction(name, params) void
+getAction(name) RoleActionParams
+getActions() ResourceActions
}
class ACLAvailableStrategy {
+options AvailableStrategyOptions
+actionsAsObject Map[string, string]
+allow(resourceName, actionName) StrategyValue
+matchAction(actionName) StrategyValue
}
class FixedParamsManager {
+merger Map[ActionPath, Array[Merger]]
+addParams(resource, action, merger) void
+getParams(resource, action) object
}
class SnippetManager {
+snippets Map[string, Snippet]
+register(snippet) void
+allow(actionPath, snippetName) boolean
}
class AllowManager {
+skipActions Map[string, Map[string, string | ConditionFunc | true]]
+registeredCondition Map[string, ConditionFunc]
+isAllowed(resourceName, actionName, ctx) boolean
+aclMiddleware() Function
}
ACL --> ACLRole : "包含"
ACLRole --> ACLResource : "包含"
ACL --> ACLAvailableStrategy : "包含"
ACL --> FixedParamsManager : "包含"
ACL --> SnippetManager : "包含"
ACL --> AllowManager : "包含"
```

**图源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [acl-resource.ts](file://packages\core\acl\src\acl-resource.ts)
- [acl-available-strategy.ts](file://packages\core\acl\src\acl-available-strategy.ts)
- [fixed-params-manager.ts](file://packages\core\acl\src\fixed-params-manager.ts)
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)
- [allow-manager.ts](file://packages\core\acl\src\allow-manager.ts)

**本节源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [acl-resource.ts](file://packages\core\acl\src\acl-resource.ts)

## 权限验证流程

NocoBase的权限验证流程通过中间件链的方式实现，确保每个请求都经过严格的权限检查。流程包括权限检查、参数合并和访问拒绝处理等关键步骤。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Middleware as "ACL中间件"
participant ACL as "ACL系统"
participant Role as "角色"
participant Resource as "资源"
participant Strategy as "策略"
Client->>Middleware : 发起请求
Middleware->>ACL : 调用can方法
ACL->>Role : 获取角色权限
Role->>Resource : 检查资源权限
Resource-->>Role : 返回权限结果
Role->>Strategy : 检查策略权限
Strategy-->>Role : 返回策略结果
Role-->>ACL : 汇总权限信息
ACL->>Middleware : 返回权限检查结果
alt 有权限
Middleware->>Middleware : 合并权限参数
Middleware->>Client : 继续处理请求
else 无权限
Middleware->>Client : 返回403错误
end
```

**图源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [server.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\server.ts)

**本节源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [server.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\server.ts)

## 角色与权限关联机制

NocoBase通过角色定义和权限策略实现角色与权限的关联。系统支持固定权限和动态权限两种实现方式，提供了灵活的权限管理能力。

```mermaid
flowchart TD
Start([角色定义]) --> DefineRole["定义角色"]
DefineRole --> SetStrategy["设置策略"]
SetStrategy --> GrantActions["授予操作权限"]
GrantActions --> CheckSnippet["检查片段权限"]
CheckSnippet --> HasSnippet{"有片段权限?"}
HasSnippet --> |是| UseSnippet["使用片段权限"]
HasSnippet --> |否| CheckResource["检查资源权限"]
CheckResource --> HasResource{"有资源权限?"}
HasResource --> |是| UseResource["使用资源权限"]
HasResource --> |否| CheckStrategy["检查策略权限"]
CheckStrategy --> HasStrategy{"有策略权限?"}
HasStrategy --> |是| UseStrategy["使用策略权限"]
HasStrategy --> |否| DenyAccess["拒绝访问"]
UseSnippet --> End([权限验证完成])
UseResource --> End
UseStrategy --> End
DenyAccess --> End
```

**图源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)

**本节源**
- [acl.ts](file://packages\core\acl\src\acl.ts)
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)

## 权限配置说明

NocoBase的权限配置通过资源操作权限的定义和分配来实现。系统提供了多种配置方式，包括固定参数、片段管理和策略定义等。

### 固定参数配置
固定参数用于为特定资源和操作设置默认的权限参数。这些参数在权限检查时会被自动合并到请求参数中。

```mermaid
classDiagram
class FixedParamsManager {
+addParams(resource, action, merger) void
+getParams(resource, action) object
}
class Merger {
<<function>>
() => object
}
FixedParamsManager --> Merger : "使用"
```

**图源**
- [fixed-params-manager.ts](file://packages\core\acl\src\fixed-params-manager.ts)

**本节源**
- [fixed-params-manager.ts](file://packages\core\acl\src\fixed-params-manager.ts)

### 片段管理
片段管理允许将权限配置分组管理，通过通配符匹配实现批量权限控制。

```mermaid
classDiagram
class SnippetManager {
+snippets Map[string, Snippet]
+register(snippet) void
+allow(actionPath, snippetName) boolean
}
class Snippet {
+name string
+actions Array[string]
}
SnippetManager --> Snippet : "包含"
```

**图源**
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)

**本节源**
- [snippet-manager.ts](file://packages\core\acl\src\snippet-manager.ts)

## 细粒度访问控制

NocoBase通过多种机制实现细粒度的访问控制，包括关联操作检查、参数过滤和权限继承等。

### 关联操作检查
对关联资源的操作进行权限检查，确保用户只能访问其有权限的关联数据。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Middleware as "中间件"
participant ACL as "ACL"
participant Repo as "仓库"
Client->>Middleware : 请求关联操作
Middleware->>ACL : 检查权限
ACL->>Repo : 查询记录
Repo-->>ACL : 返回记录
alt 记录存在
ACL-->>Middleware : 权限通过
Middleware->>Client : 继续处理
else 记录不存在
ACL-->>Middleware : 拒绝访问
Middleware->>Client : 返回403
end
```

**图源**
- [check-association-operate.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\middlewares\check-association-operate.ts)

**本节源**
- [check-association-operate.ts](file://packages\plugins\@nocobase\plugin-acl\src\server\middlewares\check-association-operate.ts)

### 权限继承机制
通过角色继承和策略继承实现权限的层级管理，简化权限配置。

```mermaid
classDiagram
class ACLRole {
+getStrategy() ACLAvailableStrategy
+getResourceActionsParams(resourceName) RoleActionParams
}
class ACLAvailableStrategy {
+allow(resourceName, actionName) StrategyValue
+matchAction(actionName) StrategyValue
}
ACLRole --> ACLAvailableStrategy : "使用"
```

**图源**
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [acl-available-strategy.ts](file://packages\core\acl\src\acl-available-strategy.ts)

**本节源**
- [acl-role.ts](file://packages\core\acl\src\acl-role.ts)
- [acl-available-strategy.ts](file://packages\core\acl\src\acl-available-strategy.ts)