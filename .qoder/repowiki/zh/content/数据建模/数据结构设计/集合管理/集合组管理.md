# 集合组管理

<cite>
**本文档引用的文件**  
- [collection-group-manager.ts](file://packages/core/database/src/collection-group-manager.ts)
- [collectionCategories.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collectionCategories.ts)
- [collections.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collections.ts)
- [dumper.ts](file://packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts)
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts)
- [ConfigurationTabs.tsx](file://packages/plugins/@nocobase/plugin-data-source-manager/src/client/component/CollectionsManager/ConfigurationTabs.tsx)
- [collection.ts](file://packages/plugins/@nocobase/plugin-data-source-manager/src/client/component/MainDataSourceManager/Configuration/schemas/collections.ts)
</cite>

## 目录
1. [引言](#引言)
2. [集合组概念与作用](#集合组概念与作用)
3. CollectionGroupManager 类实现与使用
4. 集合组配置选项
5. 集合分配与批量操作
6. 权限管理中的集合组应用
7. 最佳实践
8. 结论

## 引言

NocoBase 是一个灵活的低代码开发平台，其核心功能之一是数据集合的管理。集合组（Collection Group）作为组织和分类相关数据集合的重要机制，在系统架构中扮演着关键角色。本文档旨在深入解析 NocoBase 中集合组的管理机制，涵盖其概念、实现、配置、使用方法以及最佳实践，帮助开发者更好地理解和利用这一功能。

**Section sources**
- [collection-group-manager.ts](file://packages/core/database/src/collection-group-manager.ts#L1-L71)

## 集合组概念与作用

集合组是一种将多个相关数据集合进行逻辑分组的机制，主要用于实现数据的分类管理、批量操作和权限控制。通过集合组，可以将具有相似功能或业务关联的集合归类，便于统一管理和操作。

集合组的核心作用包括：
- **数据分类**：将相关的数据集合组织在一起，提高数据管理的条理性。
- **批量操作**：支持对组内所有集合执行统一的操作，如备份、恢复、权限设置等。
- **权限管理**：基于集合组进行权限分配，简化权限配置流程。
- **数据迁移**：在系统升级或数据迁移过程中，确保相关集合的一致性。

集合组的定义通常包含集合列表、功能描述、数据类型和延迟恢复策略等属性。在 NocoBase 中，集合组的管理主要通过 `CollectionGroupManager` 类来实现。

**Section sources**
- [collection-group-manager.ts](file://packages/core/database/src/collection-group-manager.ts#L20-L33)

## CollectionGroupManager 类实现与使用

`CollectionGroupManager` 是 NocoBase 中负责集合组管理的核心类，提供了集合组的创建、修改、删除和查询等操作。该类的实现位于 `packages/core/database/src/collection-group-manager.ts` 文件中。

### 类定义与构造函数

```typescript
export class CollectionGroupManager {
  constructor(public db: Database) {}
}
```

`CollectionGroupManager` 的构造函数接受一个 `Database` 实例作为参数，用于与数据库进行交互。该类的主要功能通过静态方法 `unifyDumpRules` 提供。

### 静态方法：unifyDumpRules

`unifyDumpRules` 方法用于统一处理集合的转储规则（dump rules），确保规则的一致性和正确性。该方法支持多种输入格式，包括字符串、对象等，并将其转换为标准化的规则对象。

```typescript
static unifyDumpRules(dumpRules: DumpRules):
  | (BaseDumpRules & {
      group: DumpRulesGroupType;
    })
  | undefined {
  if (!dumpRules) {
    return undefined;
  }

  if (typeof dumpRules === 'string') {
    return {
      group: dumpRules,
    };
  }

  if ('required' in dumpRules && (dumpRules as { required: true }).required) {
    return {
      ...dumpRules,
      group: 'required',
    };
  }

  if ('skipped' in dumpRules && (dumpRules as { skipped: true }).skipped) {
    return {
      ...dumpRules,
      group: 'skipped',
    };
  }

  return dumpRules as BaseDumpRules & {
    group: DumpRulesGroupType;
  };
}
```

该方法首先检查输入的 `dumpRules` 是否为空，若为空则返回 `undefined`。接着，根据 `dumpRules` 的类型进行不同的处理：
- 如果是字符串类型，则直接将其作为 `group` 属性的值。
- 如果包含 `required` 属性且值为 `true`，则将其 `group` 属性设置为 `'required'`。
- 如果包含 `skipped` 属性且值为 `true`，则将其 `group` 属性设置为 `'skipped'`。
- 对于其他情况，直接返回原始的 `dumpRules` 对象，并确保其包含 `group` 属性。

**Section sources**
- [collection-group-manager.ts](file://packages/core/database/src/collection-group-manager.ts#L35-L71)

## 集合组配置选项

集合组的配置选项主要包括名称、排序、可见性和转储规则等。这些选项在集合定义时通过 `options` 属性进行设置。

### 名称与排序

集合的名称（`name`）和显示名称（`title`）是基本的标识属性。排序（`sort`）属性用于控制集合在界面中的显示顺序。例如，在 `collectionCategories.ts` 文件中，`collectionCategories` 集合的定义如下：

```typescript
export default {
  dumpRules: {
    group: 'required',
  },
  migrationRules: ['overwrite', 'schema-only'],
  shared: true,
  name: 'collectionCategories',
  sortable: true,
  fields: [
    {
      name: 'id',
      type: 'snowflakeId',
      primaryKey: true,
      allowNull: false,
    },
    {
      type: 'string',
      name: 'name',
      translation: true,
    },
    {
      type: 'string',
      name: 'color',
      defaultValue: 'default',
    },
    {
      type: 'belongsToMany',
      name: 'collections',
      target: 'collections',
      foreignKey: 'categoryId',
      otherKey: 'collectionName',
      targetKey: 'name',
      through: 'collectionCategory',
    },
  ],
} as CollectionOptions;
```

### 可见性与转储规则

集合的可见性通过 `hidden` 属性控制，`hidden` 为 `true` 时集合在界面中不可见。转储规则（`dumpRules`）用于定义集合在备份和恢复过程中的行为。例如，`group: 'required'` 表示该集合属于必需组，在备份时必须包含。

**Section sources**
- [collectionCategories.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collectionCategories.ts#L13-L47)
- [collections.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collections.ts#L71-L80)

## 集合分配与批量操作

集合组的分配通过 `category` 字段实现，该字段是一个多对多关系，关联到 `collectionCategories` 集合。在 `collections.ts` 文件中，`collections` 集合的定义包含了 `category` 字段：

```typescript
{
  type: 'belongsToMany',
  name: 'category',
  target: 'collectionCategories',
  sourceKey: 'name',
  foreignKey: 'collectionName',
  otherKey: 'categoryId',
  targetKey: 'id',
  sortBy: 'sort',
  through: 'collectionCategory',
}
```

通过这个字段，可以将集合分配到不同的类别中，从而实现分组管理。批量操作通常通过集合组的 API 接口实现，例如在备份和恢复过程中，`Dumper` 类会根据集合的 `group` 属性进行分组处理。

**Section sources**
- [collections.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collections.ts#L71-L80)
- [dumper.ts](file://packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts#L129-L158)

## 权限管理中的集合组应用

集合组在权限管理中也发挥着重要作用。通过将集合分组，可以基于组进行权限分配，简化权限配置。例如，在 `ConfigurationTabs.tsx` 文件中，集合类别的管理界面允许用户通过拖拽操作调整类别的顺序，并通过 API 接口同步到后端。

```typescript
await api.resource('collectionCategories').move({
  sourceId: active.id,
  targetId: over.id,
});
```

这种基于集合组的权限管理方式，不仅提高了配置的灵活性，还增强了系统的安全性。

**Section sources**
- [ConfigurationTabs.tsx](file://packages/plugins/@nocobase/plugin-data-source-manager/src/client/component/CollectionsManager/ConfigurationTabs.tsx#L105-L108)

## 最佳实践

### 合理的分组策略

在设计集合组时，应根据业务需求和数据关联性进行合理分组。例如，可以将用户相关的集合（如用户信息、用户角色、用户权限）归为一个组，将订单相关的集合（如订单信息、订单详情、订单状态）归为另一个组。

### 命名规范

集合和集合组的命名应遵循清晰、一致的规范。建议使用小写字母和下划线分隔单词，避免使用特殊字符。例如，`user_information`、`order_details` 等。

### 配置管理

在配置集合组时，应充分利用 `dumpRules` 和 `migrationRules` 等选项，确保数据的一致性和可维护性。对于重要的集合，建议设置 `group: 'required'`，以确保在备份和恢复过程中不会遗漏。

**Section sources**
- [collection.ts](file://packages/plugins/@nocobase/plugin-data-source-manager/src/client/component/MainDataSourceManager/Configuration/schemas/collections.ts#L22-L45)

## 结论

NocoBase 的集合组管理机制为数据的组织和管理提供了强大的支持。通过 `CollectionGroupManager` 类，开发者可以方便地创建、修改、删除和查询集合组，实现数据的分类管理、批量操作和权限控制。合理的分组策略和命名规范，结合有效的配置管理，能够显著提升系统的可维护性和安全性。希望本文档能帮助开发者更好地理解和利用 NocoBase 的集合组管理功能。