# 关系建模

<cite>
**本文档中引用的文件**   
- [belongs-to-field.ts](file://packages/core/database/src/fields/belongs-to-field.ts)
- [has-one-field.ts](file://packages/core/database/src/fields/has-one-field.ts)
- [has-many-field.ts](file://packages/core/database/src/fields/has-many-field.ts)
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts)
- [relation-field.ts](file://packages/core/database/src/fields/relation-field.ts)
- [relation-repository.ts](file://packages/core/database/src/relation-repository/relation-repository.ts)
- [eager-loading-tree.ts](file://packages/core/database/src/eager-loading/eager-loading-tree.ts)
- [collection.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/collections.ts)
- [fields.ts](file://packages/plugins/@nocobase/plugin-data-source-main/src/server/collections/fields.ts)
</cite>

## 目录
1. [简介](#简介)
2. [关系类型实现机制](#关系类型实现机制)
3. [关系字段配置参数](#关系字段配置参数)
4. [关系查询优化与性能考虑](#关系查询优化与性能考虑)
5. [多对多关系中间表配置](#多对多关系中间表配置)
6. [复杂关系模型设计模式](#复杂关系模型设计模式)
7. [最佳实践与常见问题解决方案](#最佳实践与常见问题解决方案)

## 简介

NocoBase提供了一套完整的数据关系建模系统，支持多种关系类型，包括一对一、一对多、多对一和多对多关系。该系统基于Sequelize ORM构建，提供了丰富的配置选项和优化策略，使开发者能够灵活地定义和管理数据模型之间的关系。

关系建模在NocoBase中通过字段类型实现，每种关系类型都有对应的字段接口，如"一对一"、"一对多"、"多对一"和"多对多"。这些关系字段不仅定义了数据表之间的关联方式，还提供了级联操作、懒加载/急加载等高级功能。

**Section sources**
- [belongs-to-field.ts](file://packages/core/database/src/fields/belongs-to-field.ts#L1-L177)
- [has-one-field.ts](file://packages/core/database/src/fields/has-one-field.ts#L1-L243)

## 关系类型实现机制

NocoBase实现了四种基本的关系类型：belongs-to（多对一）、has-one（一对一）、has-many（一对多）和belongs-to-many（多对多）。每种关系类型都有其特定的实现机制和使用场景。

### 多对一关系 (belongs-to)

belongs-to关系表示一个模型属于另一个模型。在数据库层面，这通常通过在外键表中添加一个指向主表主键的外键来实现。

```mermaid
classDiagram
class Users {
+id : bigint
+name : string
+email : string
}
class Posts {
+id : bigint
+title : string
+content : string
+userId : bigint
}
Posts --> Users : "belongsTo"
```

**Diagram sources**
- [belongs-to-field.ts](file://packages/core/database/src/fields/belongs-to-field.ts#L1-L177)

### 一对一关系 (has-one)

has-one关系表示一个模型有一个关联的模型实例。这种关系通常用于将一个大表拆分为多个小表，以提高查询性能或实现数据隔离。

```mermaid
classDiagram
class Users {
+id : bigint
+name : string
+email : string
}
class UserProfiles {
+id : bigint
+userId : bigint
+bio : text
+avatar : string
}
Users --> UserProfiles : "hasOne"
```

**Diagram sources**
- [has-one-field.ts](file://packages/core/database/src/fields/has-one-field.ts#L1-L243)

### 一对多关系 (has-many)

has-many关系表示一个模型可以有多个关联的模型实例。这是最常见的一种关系类型，用于表示主从关系。

```mermaid
classDiagram
class Users {
+id : bigint
+name : string
+email : string
}
class Posts {
+id : bigint
+title : string
+content : string
+userId : bigint
}
Users --> Posts : "hasMany"
```

**Diagram sources**
- [has-many-field.ts](file://packages/core/database/src/fields/has-many-field.ts#L1-L252)

### 多对多关系 (belongs-to-many)

belongs-to-many关系表示两个模型之间存在多对多的关联。这种关系需要通过一个中间表（也称为连接表或关联表）来实现。

```mermaid
classDiagram
class Users {
+id : bigint
+name : string
+email : string
}
class Roles {
+id : bigint
+name : string
+description : string
}
class UsersRoles {
+userId : bigint
+roleId : bigint
}
Users --> UsersRoles : "through"
Roles --> UsersRoles : "through"
```

**Diagram sources**
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts#L1-L247)

## 关系字段配置参数

NocoBase的关系字段提供了丰富的配置选项，允许开发者精确控制关系的行为和特性。

### 基础配置参数

所有关系字段都继承自`RelationField`基类，共享一些基础配置参数：

```mermaid
classDiagram
class RelationField {
+target : string
+foreignKey : string
+sourceKey : string
+targetKey : string
+onDelete : string
+onUpdate : string
}
```

**Diagram sources**
- [relation-field.ts](file://packages/core/database/src/fields/relation-field.ts#L1-L90)

#### target
目标集合名称，指定关系关联到哪个数据表。如果未指定，则默认使用字段名称。

#### foreignKey
外键字段名称，用于存储关联记录的主键值。系统会根据命名约定自动生成默认值。

#### sourceKey
源键字段名称，通常是源模型的主键。默认值为模型的主键属性。

#### targetKey
目标键字段名称，通常是目标模型的主键。默认值为模型的主键属性。

### 级联操作配置

级联操作定义了当主记录被删除或更新时，关联记录应该如何处理。

```mermaid
flowchart TD
A[主记录操作] --> B{操作类型}
B --> |删除| C[onDelete 配置]
B --> |更新| D[onUpdate 配置]
C --> E[CASCADE: 级联删除]
C --> F[SET NULL: 设为空]
C --> G[RESTRICT: 限制删除]
D --> H[CASCADE: 级联更新]
D --> I[RESTRICT: 限制更新]
```

**Diagram sources**
- [belongs-to-field.ts](file://packages/core/database/src/fields/belongs-to-field.ts#L42-L48)
- [has-many-field.ts](file://packages/core/database/src/fields/has-many-field.ts#L61-L68)

### 懒加载与急加载策略

NocoBase支持灵活的加载策略，允许开发者根据性能需求选择合适的加载方式。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Server as "服务器"
participant DB as "数据库"
Client->>Server : 请求数据
alt 懒加载
Server->>DB : 查询主表数据
DB-->>Server : 返回主表数据
Server-->>Client : 返回主表数据
Client->>Server : 请求关联数据
Server->>DB : 查询关联表数据
DB-->>Server : 返回关联数据
Server-->>Client : 返回关联数据
else 急加载
Server->>DB : 联合查询主表和关联表
DB-->>Server : 返回完整数据
Server-->>Client : 返回完整数据
end
```

**Diagram sources**
- [eager-loading-tree.ts](file://packages/core/database/src/eager-loading/eager-loading-tree.ts#L1-L387)

## 关系查询优化与性能考虑

为了确保关系查询的高性能，NocoBase提供了一系列优化策略和技术。

### 查询优化器

NocoBase的查询优化器会自动分析查询语句，并选择最优的执行计划。

```mermaid
flowchart TD
A[原始查询] --> B[查询解析]
B --> C[执行计划生成]
C --> D{优化策略}
D --> E[索引选择]
D --> F[连接顺序优化]
D --> G[子查询优化]
D --> H[缓存策略]
E --> I[优化后查询]
F --> I
G --> I
H --> I
I --> J[执行查询]
```

**Diagram sources**
- [eager-loading-tree.ts](file://packages/core/database/src/eager-loading/eager-loading-tree.ts#L100-L189)

### 索引优化

合理使用索引是提高查询性能的关键。NocoBase会自动为外键字段创建索引。

```mermaid
classDiagram
class Users {
+id : bigint [PK]
+name : string [INDEX]
+email : string [UNIQUE]
}
class Posts {
+id : bigint [PK]
+title : string [INDEX]
+content : string
+userId : bigint [FK, INDEX]
}
Posts --> Users : "userId 外键索引"
```

**Diagram sources**
- [has-many-field.ts](file://packages/core/database/src/fields/has-many-field.ts#L192-L193)
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts#L211-L212)

### 缓存策略

NocoBase实现了多级缓存机制，包括查询结果缓存和关系元数据缓存。

```mermaid
flowchart TD
A[客户端请求] --> B{缓存检查}
B --> |命中| C[返回缓存数据]
B --> |未命中| D[执行数据库查询]
D --> E[处理查询结果]
E --> F[存入缓存]
F --> G[返回结果]
C --> H[响应客户端]
G --> H
```

**Diagram sources**
- [relation-repository.ts](file://packages/core/database/src/relation-repository/relation-repository.ts#L145-L179)

## 多对多关系中间表配置

多对多关系需要通过中间表来实现，NocoBase提供了灵活的中间表配置选项。

### 中间表自动生成

当定义belongs-to-many关系时，如果指定的中间表不存在，系统会自动创建。

```mermaid
classDiagram
class Users {
+id : bigint
+name : string
}
class Roles {
+id : bigint
+name : string
}
class UsersRoles {
+userId : bigint
+roleId : bigint
+createdAt : datetime
+updatedAt : datetime
}
Users --> UsersRoles : "通过中间表"
Roles --> UsersRoles : "通过中间表"
```

**Diagram sources**
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts#L142-L164)

### 中间表手动配置

开发者也可以手动创建和配置中间表，以满足特定的业务需求。

```mermaid
flowchart TD
A[定义关系] --> B{中间表存在?}
B --> |是| C[使用现有中间表]
B --> |否| D[创建新中间表]
D --> E[配置表结构]
E --> F[添加额外字段]
F --> G[设置索引]
G --> H[完成配置]
```

**Diagram sources**
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts#L142-L164)

## 复杂关系模型设计模式

NocoBase支持多种复杂的关系模型设计模式，满足不同的业务场景需求。

### 递归关系

递归关系用于表示树形结构或层级关系，如组织架构、分类目录等。

```mermaid
classDiagram
class Categories {
+id : bigint
+name : string
+parentId : bigint
+path : string
+level : integer
}
Categories --> Categories : "自引用"
```

**Diagram sources**
- [tree-collection.ts](file://packages/plugins/@nocobase/plugin-collection-tree/src/server/tree-collection.ts#L1-L21)
- [adjacency-list-repository.ts](file://packages/plugins/@nocobase/plugin-collection-tree/src/server/adjacency-list-repository.ts#L1-L126)

### 多态关联

多态关联允许一个模型与多个不同类型的模型建立关系。

```mermaid
classDiagram
class Comments {
+id : bigint
+content : text
+commentableId : bigint
+commentableType : string
}
class Posts {
+id : bigint
+title : string
}
class Products {
+id : bigint
+name : string
}
Comments --> Posts : "多态关联"
Comments --> Products : "多态关联"
```

**Diagram sources**
- [relation-field.ts](file://packages/core/database/src/fields/relation-field.ts#L55-L72)

## 最佳实践与常见问题解决方案

### 关系字段命名规范

遵循一致的命名规范有助于提高代码的可读性和可维护性。

```mermaid
flowchart TD
A[关系类型] --> B{命名规则}
B --> C[belongs-to: singular + TargetKey]
B --> D[has-many: plural + TargetKey]
B --> E[belongs-to-many: plural + TargetName]
C --> F[示例: userId, categoryId]
D --> G[示例: posts, comments]
E --> H[示例: roles, tags]
```

**Diagram sources**
- [belongs-to-field.ts](file://packages/core/database/src/fields/belongs-to-field.ts#L58-L59)
- [has-many-field.ts](file://packages/core/database/src/fields/has-many-field.ts#L95-L96)

### 性能优化建议

针对常见的性能问题，提供以下优化建议：

```mermaid
flowchart TD
A[性能问题] --> B{问题类型}
B --> C[查询慢]
B --> D[内存占用高]
B --> E[写入性能差]
C --> F[添加适当索引]
C --> G[优化查询语句]
C --> H[使用缓存]
D --> I[避免N+1查询]
D --> J[使用分页]
D --> K[限制返回字段]
E --> L[批量操作]
E --> M[事务优化]
E --> N[异步处理]
```

**Diagram sources**
- [eager-loading-tree.ts](file://packages/core/database/src/eager-loading/eager-loading-tree.ts#L192-L204)
- [relation-repository.ts](file://packages/core/database/src/relation-repository/relation-repository.ts#L84-L118)

### 常见问题排查

针对关系建模中的常见问题，提供排查指南：

```mermaid
flowchart TD
A[问题现象] --> B{具体表现}
B --> C[关系数据未加载]
B --> D[外键约束错误]
B --> E[循环依赖]
C --> F[检查加载策略]
C --> G[验证字段配置]
D --> H[检查数据类型匹配]
D --> I[验证外键值]
E --> J[分析依赖图]
E --> K[重构模型结构]
```

**Diagram sources**
- [relation-field.ts](file://packages/core/database/src/fields/relation-field.ts#L55-L72)
- [belongs-to-many-field.ts](file://packages/core/database/src/fields/belongs-to-many-field.ts#L105-L115)