# 传统服务器部署

<cite>
**本文档中引用的文件**   
- [README.md](file://README.md)
- [package.json](file://package.json)
- [.env.example](file://.env.example)
- [docker/nocobase/nocobase.conf](file://docker/nocobase/nocobase.conf)
- [docker/nocobase/Dockerfile](file://docker/nocobase/Dockerfile)
- [docker/nocobase/docker-entrypoint.sh](file://docker/nocobase/docker-entrypoint.sh)
- [packages/core/cli/src/commands/pm2.js](file://packages/core/cli/src/commands/pm2.js)
- [packages/core/cli/src/commands/start.js](file://packages/core/cli/src/commands/start.js)
- [packages/core/cli/nocobase.conf.tpl](file://packages/core/cli/nocobase.conf.tpl)
- [packages/core/cli/src/commands/create-nginx-conf.js](file://packages/core/cli/src/commands/create-nginx-conf.js)
- [packages/core/server/src/environment.ts](file://packages/core/server/src/environment.ts)
- [packages/plugins/@nocobase/plugin-environment-variables/src/server/plugin.ts](file://packages/plugins/@nocobase/plugin-environment-variables/src/server/plugin.ts)
- [packages/core/server/src/application.ts](file://packages/core/server/src/application.ts)
- [packages/core/logger/src/system-logger.ts](file://packages/core/logger/src/system-logger.ts)
- [packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts](file://packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts)
- [packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts](file://packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts)
- [packages/plugins/@nocobase/plugin-backup-restore/src/client/Configuration.tsx](file://packages/plugins/@nocobase/plugin-backup-restore/src/client/Configuration.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求与环境准备](#系统要求与环境准备)
3. [NocoBase安装与配置](#nocobase安装与配置)
4. [PM2进程管理配置](#pm2进程管理配置)
5. [Nginx反向代理配置](#nginx反向代理配置)
6. [系统服务配置](#系统服务配置)
7. [环境变量与配置文件管理](#环境变量与配置文件管理)
8. [数据库连接配置](#数据库连接配置)
9. [生产环境安全加固](#生产环境安全加固)
10. [性能监控与日志管理](#性能监控与日志管理)
11. [定期备份策略](#定期备份策略)
12. [故障排除指南](#故障排除指南)

## 简介

NocoBase是一个可扩展的AI驱动的无代码平台，支持多种部署方式。本指南详细说明如何在Linux服务器上进行传统服务器部署，包括使用PM2进行进程管理、Nginx反向代理配置、系统服务设置、环境变量管理、数据库连接配置、安全加固措施、性能监控和日志管理等方面的内容。

**Section sources**
- [README.md](file://README.md#L1-L96)

## 系统要求与环境准备

在部署NocoBase之前，需要确保服务器满足以下系统要求：

- 操作系统：Linux（推荐Ubuntu 20.04 LTS或更高版本）
- Node.js版本：18或更高版本
- 内存：至少4GB RAM
- 存储空间：至少20GB可用空间
- 数据库：PostgreSQL、MySQL、MariaDB或SQLite

首先，更新系统包并安装必要的依赖：

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y nginx git curl wget
```

安装Node.js和yarn：

```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
npm install -g yarn
```

**Section sources**
- [package.json](file://package.json#L9-L11)
- [docker/nocobase/Dockerfile](file://docker/nocobase/Dockerfile#L1)

## NocoBase安装与配置

通过npm全局安装NocoBase CLI工具：

```bash
npm install -g @nocobase/cli
```

创建新的NocoBase应用：

```bash
npx create-nocobase-app my-nocobase-app
cd my-nocobase-app
```

根据项目需求选择合适的安装方式。对于生产环境，建议使用create-nocobase-app CLI方式进行安装，这样可以完全独立业务代码并支持低代码开发。

**Section sources**
- [README.md](file://README.md#L77-L91)
- [package.json](file://package.json#L19-L25)

## PM2进程管理配置

PM2是Node.js应用程序的进程管理器，可以确保NocoBase应用在后台持续运行，并在崩溃时自动重启。

首先全局安装PM2：

```bash
npm install -g pm2
```

NocoBase内置了对PM2的支持，可以通过以下命令启动应用：

```bash
yarn pm2 start
```

或者使用NocoBase CLI命令：

```bash
yarn nocobase pm2
```

PM2配置文件可以创建为`ecosystem.config.js`：

```javascript
module.exports = {
  apps: [
    {
      name: 'nocobase',
      script: './node_modules/.bin/nocobase',
      args: 'start',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'development',
        APP_PORT: 13000,
      },
      env_production: {
        NODE_ENV: 'production',
        APP_PORT: 13000,
      },
    },
  ],
};
```

使用PM2管理命令：

```bash
# 启动应用
pm2 start ecosystem.config.js --env production

# 停止应用
pm2 stop nocobase

# 重启应用
pm2 restart nocobase

# 查看应用状态
pm2 list

# 查看日志
pm2 logs nocobase
```

**Section sources**
- [package.json](file://package.json#L21)
- [packages/core/cli/src/commands/pm2.js](file://packages/core/cli/src/commands/pm2.js#L1-L37)
- [packages/core/cli/src/commands/start.js](file://packages/core/cli/src/commands/start.js#L126-L137)

## Nginx反向代理配置

Nginx作为反向代理服务器，可以提高NocoBase应用的安全性和性能。

### 基本反向代理配置

创建Nginx配置文件`/etc/nginx/sites-available/nocobase`：

```nginx
log_format apm '"$time_local" client=$remote_addr '
               'method=$request_method request="$request" '
               'request_length=$request_length '
               'status=$status bytes_sent=$bytes_sent '
               'body_bytes_sent=$body_bytes_sent '
               'referer=$http_referer '
               'user_agent="$http_user_agent" '
               'upstream_addr=$upstream_addr '
               'upstream_status=$upstream_status '
               'request_time=$request_time '
               'upstream_response_time=$upstream_response_time '
               'upstream_connect_time=$upstream_connect_time '
               'upstream_header_time=$upstream_header_time';

server {
    listen 80;
    server_name your-domain.com;
    root /path/to/nocobase/node_modules/@nocobase/app/dist/client;
    index index.html;
    client_max_body_size 0;
    access_log /var/log/nginx/nocobase.log apm;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 不缓存 HTML 文件
    location ~ \.html$ {
      if_modified_since off;
      expires off;
      etag off;
    }

    # 缓存 JavaScript 和 CSS 文件
    location ~* \.(js|css)$ {
      expires 365d;
      add_header Cache-Control "public";
    }

    location /storage/uploads/ {
        alias /path/to/nocobase/storage/uploads/;
        add_header Cache-Control "public";
        access_log off;
        autoindex off;
    }

    location / {
        root /path/to/nocobase/node_modules/@nocobase/app/dist/client;
        try_files $uri $uri/ /index.html;
        add_header Last-Modified $date_gmt;
        add_header Cache-Control 'no-store, no-cache';
        if_modified_since off;
        expires off;
        etag off;
    }

    location ^~ /api/ {
        proxy_pass http://127.0.0.1:13000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }

    location ^~ /static/plugins/ {
        proxy_pass http://127.0.0.1:13000/static/plugins/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
        send_timeout 600;
    }

    location /ws {
      proxy_pass http://127.0.0.1:13000/ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "Upgrade";
      proxy_set_header Host $host;
    }
}
```

启用配置并重启Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/nocobase /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### SSL证书配置

使用Let's Encrypt获取SSL证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

Certbot会自动更新Nginx配置以使用SSL证书。

### 负载均衡设置

对于高可用性部署，可以配置Nginx作为负载均衡器：

```nginx
upstream nocobase_backend {
    server 127.0.0.1:13001;
    server 127.0.0.1:13002;
    server 127.0.0.1:13003;
}

server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /path/to/fullchain.pem;
    ssl_certificate_key /path/to/privkey.pem;

    location /api/ {
        proxy_pass http://nocobase_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
        
        # 负载均衡策略
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
    }
}
```

**Section sources**
- [docker/nocobase/nocobase.conf](file://docker/nocobase/nocobase.conf#L1-L90)
- [packages/core/cli/nocobase.conf.tpl](file://packages/core/cli/nocobase.conf.tpl#L1-L37)
- [packages/core/cli/src/commands/create-nginx-conf.js](file://packages/core/cli/src/commands/create-nginx-conf.js#L1-L37)

## 系统服务配置

为了确保NocoBase在系统启动时自动运行，需要创建systemd服务文件。

创建服务文件`/etc/systemd/system/nocobase.service`：

```ini
[Unit]
Description=NocoBase Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/nocobase
ExecStart=/usr/bin/yarn start
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=APP_PORT=13000

# 环境变量文件
EnvironmentFile=/path/to/nocobase/.env

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl daemon-reexec
sudo systemctl enable nocobase
sudo systemctl start nocobase
```

管理服务的命令：

```bash
# 查看服务状态
sudo systemctl status nocobase

# 停止服务
sudo systemctl stop nocobase

# 重启服务
sudo systemctl restart nocobase

# 查看服务日志
sudo journalctl -u nocobase -f
```

**Section sources**
- [package.json](file://package.json#L24)
- [.env.example](file://.env.example#L1-L98)

## 环境变量与配置文件管理

NocoBase使用环境变量进行配置管理，主要配置文件为`.env`。

### 环境变量配置

创建`.env`文件：

```env
# 应用环境
APP_ENV=production
APP_PORT=13000
APP_KEY=your-secret-key

# API配置
API_BASE_PATH=/api/

# 日志配置
LOGGER_TRANSPORT=file
LOGGER_BASE_PATH=storage/logs
LOGGER_LEVEL=info
LOGGER_MAX_FILES=30d
LOGGER_MAX_SIZE=10m
LOGGER_FORMAT=json

# 集群模式
CLUSTER_MODE=1

# 工作模式
WORKER_MODE=

# 数据库配置
DB_DIALECT=postgres
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=nocobase
DB_USER=nocobase
DB_PASSWORD=your-password
DB_POOL_MAX=20
DB_POOL_MIN=2
DB_POOL_IDLE=30000
DB_POOL_ACQUIRE=60000
DB_POOL_EVICT=1000

# 缓存配置
CACHE_DEFAULT_STORE=redis
CACHE_REDIS_URL=redis://localhost:6379

# 初始化配置
INIT_ROOT_EMAIL=admin@your-domain.com
INIT_ROOT_PASSWORD=your-admin-password
```

### 环境变量管理插件

NocoBase提供了环境变量管理插件，可以通过UI界面管理环境变量：

```bash
yarn pm enable environment-variables
```

该插件允许在运行时动态设置和管理环境变量，支持加密存储敏感信息。

**Section sources**
- [.env.example](file://.env.example#L1-L98)
- [packages/core/server/src/environment.ts](file://packages/core/server/src/environment.ts#L1-L47)
- [packages/plugins/@nocobase/plugin-environment-variables/src/server/plugin.ts](file://packages/plugins/@nocobase/plugin-environment-variables/src/server/plugin.ts#L1-L219)

## 数据库连接配置

NocoBase支持多种数据库，包括PostgreSQL、MySQL、MariaDB和SQLite。

### 数据库连接池设置

在`.env`文件中配置数据库连接池参数：

```env
# 数据库连接池设置
DB_POOL_MAX=20
DB_POOL_MIN=2
DB_POOL_IDLE=30000
DB_POOL_ACQUIRE=60000
DB_POOL_EVICT=1000
DB_POOL_MAX_USES=0
```

这些参数的含义：

- `DB_POOL_MAX`: 连接池中最大连接数
- `DB_POOL_MIN`: 连接池中最小连接数
- `DB_POOL_IDLE`: 连接在池中保持空闲而不被释放的时间（毫秒）
- `DB_POOL_ACQUIRE`: 获取连接的超时时间（毫秒）
- `DB_POOL_EVICT`: 从连接池中移除空闲连接的时间间隔（毫秒）
- `DB_POOL_MAX_USES`: 每个连接的最大使用次数

### 性能优化建议

1. **连接池大小**: 根据应用的并发需求调整连接池大小。一般建议设置为CPU核心数的2-4倍。

2. **连接超时**: 设置合理的连接超时时间，避免长时间等待数据库连接。

3. **索引优化**: 为常用查询字段创建索引，提高查询性能。

4. **查询优化**: 避免N+1查询问题，使用批量查询和预加载。

5. **缓存策略**: 使用Redis等缓存系统缓存频繁访问的数据。

**Section sources**
- [.env.example](file://.env.example#L46-L67)
- [packages/core/server/src/application.ts](file://packages/core/server/src/application.ts#L1250-L1263)

## 生产环境安全加固

### 防火墙配置

使用ufw配置防火墙规则：

```bash
# 允许SSH
sudo ufw allow OpenSSH

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许NocoBase端口（如果直接访问）
sudo ufw allow 13000/tcp

# 启用防火墙
sudo ufw enable
```

### 用户权限管理

创建专用用户运行NocoBase应用：

```bash
# 创建nocobase用户
sudo adduser nocobase

# 将用户添加到www-data组
sudo usermod -a -G www-data nocobase

# 设置目录权限
sudo chown -R nocobase:www-data /path/to/nocobase
sudo chmod -R 755 /path/to/nocobase
```

### 其他安全措施

1. **定期更新**: 定期更新系统和应用程序，修复安全漏洞。

2. **安全头设置**: 在Nginx配置中添加安全头：

```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
```

3. **文件上传限制**: 限制上传文件大小和类型，防止恶意文件上传。

4. **API安全**: 使用API密钥和身份验证保护API端点。

**Section sources**
- [docker/nocobase/Dockerfile](file://docker/nocobase/Dockerfile#L24-L36)
- [docker/nocobase/docker-entrypoint.sh](file://docker/nocobase/docker-entrypoint.sh#L35-L37)

## 性能监控与日志管理

### 日志配置

NocoBase支持多种日志传输方式，可以在`.env`文件中配置：

```env
# 日志传输方式：console | file | dailyRotateFile
LOGGER_TRANSPORT=dailyRotateFile
# 日志基础路径
LOGGER_BASE_PATH=storage/logs
# 日志级别：error | warn | info | debug | trace
LOGGER_LEVEL=info
# 日志文件保留天数
LOGGER_MAX_FILES=30d
# 单个日志文件最大大小
LOGGER_MAX_SIZE=10m
# 日志格式：console | json | logfmt | delimiter
LOGGER_FORMAT=json
```

### 日志文件结构

NocoBase生成的日志文件位于`storage/logs`目录下，包括：

- `system.log`: 系统日志
- `request.log`: 请求日志
- `sql.log`: SQL查询日志
- `error.log`: 错误日志（如果启用分离错误日志）

### 日志管理插件

NocoBase提供了日志管理插件，可以通过UI界面查看和下载日志文件：

```bash
yarn pm enable logger
```

该插件提供了以下功能：

- 查看服务器日志文件列表
- 下载日志文件
- 收集诊断信息

### 性能监控

1. **PM2监控**: 使用PM2的监控功能：

```bash
# 查看应用监控信息
pm2 monit

# 查看CPU和内存使用情况
pm2 list
```

2. **系统监控**: 使用系统工具监控服务器性能：

```bash
# 实时监控系统资源
htop

# 监控磁盘I/O
iotop

# 监控网络流量
iftop
```

3. **数据库监控**: 监控数据库性能指标，如连接数、查询性能等。

**Section sources**
- [.env.example](file://.env.example#L20-L30)
- [packages/core/server/src/application.ts](file://packages/core/server/src/application.ts#L1230-L1246)
- [packages/core/logger/src/system-logger.ts](file://packages/core/logger/src/system-logger.ts#L44-L97)
- [packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts](file://packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts#L87-L157)

## 定期备份策略

### 备份配置

NocoBase提供了备份恢复插件，可以配置定期备份策略：

```bash
yarn pm enable backup-restore
```

### 备份类型

备份包括以下几种类型：

- **元数据**: 系统配置、插件设置等
- **配置数据**: 用户、角色、权限等配置信息
- **业务数据**: 应用中的业务数据

### 自动备份脚本

创建自动备份脚本`backup.sh`：

```bash
#!/bin/bash

# 备份目录
BACKUP_DIR="/path/to/backups"
# 保留天数
RETAIN_DAYS=30

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行NocoBase备份
cd /path/to/nocobase
yarn nocobase backup:create --dataTypes=meta,config,business

# 清理旧备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +$RETAIN_DAYS -delete

# 发送备份完成通知（可选）
# curl -X POST https://your-notification-service.com/backup-complete
```

设置定时任务：

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

### 备份验证

定期验证备份文件的完整性和可恢复性：

```bash
# 检查备份文件状态
yarn nocobase backup:status

# 下载备份文件进行验证
yarn nocobase backup:download --filename=backup_20231201_120000.tar.gz
```

**Section sources**
- [packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts](file://packages/plugins/@nocobase/plugin-backup-restore/src/server/dumper.ts#L42-L290)
- [packages/plugins/@nocobase/plugin-backup-restore/src/client/Configuration.tsx](file://packages/plugins/@nocobase/plugin-backup-restore/src/client/Configuration.tsx#L260-L306)

## 故障排除指南

### 常见问题及解决方案

1. **应用无法启动**
   - 检查端口是否被占用：`netstat -tlnp | grep 13000`
   - 检查日志文件：`tail -f storage/logs/system.log`
   - 检查环境变量配置是否正确

2. **数据库连接失败**
   - 检查数据库服务是否运行：`sudo systemctl status postgresql`
   - 检查数据库连接参数是否正确
   - 检查防火墙是否阻止数据库端口

3. **Nginx反向代理问题**
   - 检查Nginx配置语法：`sudo nginx -t`
   - 检查Nginx错误日志：`sudo tail -f /var/log/nginx/error.log`
   - 检查代理目标是否可达

4. **性能问题**
   - 检查CPU和内存使用情况：`htop`
   - 检查数据库查询性能：分析慢查询日志
   - 检查连接池配置是否合理

5. **SSL证书问题**
   - 检查证书文件路径是否正确
   - 检查证书是否过期：`sudo certbot certificates`
   - 重新获取证书：`sudo certbot renew`

### 调试工具

1. **PM2日志**: `pm2 logs nocobase`
2. **系统日志**: `journalctl -u nocobase -f`
3. **Nginx日志**: `tail -f /var/log/nginx/access.log` 和 `tail -f /var/log/nginx/error.log`
4. **数据库日志**: 根据数据库类型查看相应日志文件

**Section sources**
- [packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts](file://packages/plugins/@nocobase/plugin-logger/src/server/resourcer/logger.ts#L87-L157)
- [packages/core/server/src/application.ts](file://packages/core/server/src/application.ts#L1242-L1246)