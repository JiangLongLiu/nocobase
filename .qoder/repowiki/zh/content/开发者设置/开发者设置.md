# 开发者设置

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [lerna.json](file://lerna.json)
- [tsconfig.json](file://tsconfig.json)
- [tsconfig.server.json](file://tsconfig.server.json)
- [.eslintrc](file://.eslintrc)
- [.prettierrc](file://.prettierrc)
- [.editorconfig](file://.editorconfig)
- [commitlint.config.js](file://commitlint.config.js)
- [.yarnrc](file://.yarnrc)
- [vitest.config.mts](file://vitest.config.mts)
- [playwright.config.ts](file://playwright.config.ts)
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [packages/core/devtools/package.json](file://packages/core/devtools/package.json)
- [packages/core/cli/package.json](file://packages/core/cli/package.json)
- [packages/core/build/package.json](file://packages/core/build/package.json)
- [packages/core/test/package.json](file://packages/core/test/package.json)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境搭建](#开发环境搭建)
3. [TypeScript配置](#typescript配置)
4. [代码风格与格式化](#代码风格与格式化)
5. [调试工具配置](#调试工具配置)
6. [开发服务器与热重载](#开发服务器与热重载)
7. [贡献指南](#贡献指南)
8. [本地开发最佳实践](#本地开发最佳实践)

## 简介
NocoBase是一个基于Node.js的无代码/低代码平台，支持模块化插件架构和多工作区管理。本指南详细说明了如何设置本地开发环境，包括必要的工具链、代码规范、调试配置和贡献流程。

## 开发环境搭建

### Node.js版本要求
根据`package.json`中的`engines`字段，NocoBase要求Node.js版本不低于18。项目中还包含`volta`配置，推荐使用Node.js 20.14.0版本以确保环境一致性。

```json
"engines": {
  "node": ">=18"
},
"volta": {
  "node": "20.14.0",
  "yarn": "1.22.19"
}
```

### 依赖安装
NocoBase使用Yarn作为包管理器，并通过Lerna管理多包仓库结构。安装依赖的步骤如下：

1. 确保已安装Yarn（推荐1.22.19版本）
2. 执行`yarn install`安装所有工作区的依赖
3. 项目使用`workspaces`配置，自动管理`packages/*/*`和`packages/*/*/*`目录下的包

Lerna配置指定了使用Yarn作为npm客户端，并忽略引擎检查：

```json
{
  "npmClient": "yarn",
  "useWorkspaces": true,
  "npmClientArgs": ["--ignore-engines"]
}
```

### 开发工具配置
核心开发工具包`@nocobase/devtools`包含了项目所需的主要开发依赖，包括：
- TypeScript编译器（5.1.3版本）
- ESLint和Prettier用于代码检查和格式化
- 测试框架Vitest和Playwright
- 构建工具如tsup、rsbuild等

**Section sources**
- [package.json](file://package.json#L93-L94)
- [lerna.json](file://lerna.json#L3-L5)
- [packages/core/devtools/package.json](file://packages/core/devtools/package.json#L44-L46)

## TypeScript配置

### 基础配置
项目的主`tsconfig.json`文件定义了TypeScript编译选项，主要特点包括：
- 使用ESNext作为目标和模块格式
- 启用ES模块互操作性
- 支持JSX语法
- 生成源码映射文件
- 启用实验性装饰器
- 基于`tsconfig.paths.json`进行路径扩展

```json
{
  "extends": "./tsconfig.paths.json",
  "compilerOptions": {
    "esModuleInterop": true,
    "moduleResolution": "node",
    "jsx": "react",
    "target": "esnext",
    "module": "esnext",
    "sourceMap": true,
    "inlineSources": true,
    "resolveJsonModule": true,
    "declaration": true,
    "experimentalDecorators": true
  }
}
```

### 服务端特殊配置
`tsconfig.server.json`文件继承自主配置，但针对服务端代码进行了调整：
- 目标版本为ES6
- 模块系统为CommonJS

这种配置确保服务端代码在Node.js环境中能够正确运行。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L3-L26)
- [tsconfig.server.json](file://tsconfig.server.json#L1-L6)

## 代码风格与格式化

### ESLint配置
ESLint配置文件`.eslintrc`设置了代码质量检查规则，主要特点包括：
- 继承了多个推荐配置：TypeScript、React、Promise和Prettier
- 使用`@typescript-eslint/parser`作为解析器
- 配置了React版本自动检测
- 在e2e测试文件中启用了严格的异步函数检查

```json
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended",
    "plugin:promise/recommended",
    "plugin:prettier/recommended"
  ],
  "parser": "@typescript-eslint/parser"
}
```

### Prettier配置
Prettier配置文件`.prettierrc`定义了代码格式化规则：
- 使用单引号
- 末尾逗号采用"all"策略
- 每行最大长度为120个字符
- 对`.prettierrc`文件本身使用JSON解析器

```json
{
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 120,
  "overrides": [
    {
      "files": ".prettierrc",
      "options": { "parser": "json" }
    }
  ]
}
```

### EditorConfig
`.editorconfig`文件定义了编辑器的基本设置：
- 使用2个空格进行缩进
- 换行符为LF
- 字符编码为UTF-8
- 去除行尾空白字符
- 文件末尾插入新行

这些配置确保了不同开发者使用不同编辑器时代码风格的一致性。

**Section sources**
- [.eslintrc](file://.eslintrc#L7-L14)
- [.prettierrc](file://.prettierrc#L1-L11)
- [.editorconfig](file://.editorconfig#L1-L17)

## 调试工具配置

### 源码映射
TypeScript配置中启用了源码映射功能，确保在调试时能够直接定位到原始TypeScript文件：

```json
"compilerOptions": {
  "sourceMap": true,
  "inlineSources": true
}
```

### 提交信息规范
项目使用Commitlint进行提交信息规范化，通过`commitlint.config.js`文件定义规则。虽然`.commitlintrc`文件不存在，但`package.json`中的`config`字段配置了commit-msg钩子：

```json
"config": {
  "ghooks": {
    "commit-msg": "commitlint --edit"
  }
}
```

### 调试脚本
项目提供了多种调试相关的npm脚本：
- `test`、`test:server`、`test:client`：运行不同类型测试
- `e2e`：运行端到端测试
- `lint`：执行代码检查

测试配置使用Vitest作为主要测试框架，并集成Playwright进行e2e测试。

**Section sources**
- [tsconfig.json](file://tsconfig.json#L14-L15)
- [commitlint.config.js](file://commitlint.config.js)
- [package.json](file://package.json#L63-L66)
- [vitest.config.mts](file://vitest.config.mts)
- [playwright.config.ts](file://playwright.config.ts)

## 开发服务器与热重载

### 启动脚本
项目提供了多个启动开发服务器的脚本：
- `dev`：启动完整的开发服务器
- `dev-server`：仅启动服务端开发服务器
- `start`：启动生产环境服务器

这些脚本都通过`@nocobase/cli`包的`nocobase`命令实现。

### Docker开发环境
`docker-compose.yml`文件定义了完整的开发环境，包含：
- MySQL、PostgreSQL、Kingbase等数据库服务
- Verdaccio私有npm仓库
- Adminer数据库管理工具
- NocoBase应用本身

开发环境通过环境变量进行配置，支持多种数据库类型。

### 热重载配置
虽然具体热重载配置未在查看的文件中明确显示，但`@nocobase/devtools`包中包含了`ts-node-dev`等热重载相关工具，表明项目支持开发过程中的自动重启功能。

**Section sources**
- [package.json](file://package.json#L22-L24)
- [docker-compose.yml](file://docker-compose.yml#L1-L80)
- [packages/core/devtools/package.json](file://packages/core/devtools/package.json#L41-L42)

## 贡献指南

### 代码提交规范
项目通过husky和commitlint确保提交信息的规范性：
- pre-commit钩子执行`lint-staged`和许可证添加
- commit-msg钩子验证提交信息格式

```json
"config": {
  "ghooks": {
    "pre-commit": "yarn lint-staged && node ./scripts/addLicense.js",
    "commit-msg": "commitlint --edit"
  }
}
```

### Pull Request流程
虽然具体的PR模板未在查看的文件中，但项目结构表明：
- 使用GitHub进行代码托管
- 采用Lerna管理多包版本
- 有完整的测试套件（单元测试、e2e测试）

### 代码审查标准
代码审查标准主要体现在：
- 严格的TypeScript类型检查
- ESLint代码质量检查
- Prettier代码格式化
- 测试覆盖率要求

`lint-staged`配置确保了暂存文件在提交前经过格式化和检查：

```json
"lint-staged": {
  "*.{js,json}": ["prettier --write"],
  "*.ts?(x)": ["eslint --fix"]
}
```

**Section sources**
- [package.json](file://package.json#L62-L74)
- [lerna.json](file://lerna.json#L6-L11)

## 本地开发最佳实践

### 分支管理
项目使用Lerna进行版本管理和发布，建议的分支策略包括：
- 主分支用于稳定版本
- 功能分支用于新功能开发
- 发布分支用于版本准备

### 依赖更新
由于项目使用固定的依赖版本（通过`resolutions`字段），更新依赖时需要注意：
- 保持核心依赖版本一致性
- 测试更新后的兼容性
- 遵循Lerna的版本管理流程

### 版本控制
`.gitignore`文件确保了正确的文件忽略策略，包括：
- node_modules目录
- 构建输出目录
- 环境配置文件
- 存储目录中的特定文件

项目还使用patch-package来管理第三方包的补丁，`patches`目录中包含了React类型的补丁文件。

**Section sources**
- [package.json](file://package.json#L48-L61)
- [lerna.json](file://lerna.json#L2)
- [.gitignore](file://.gitignore)
- [patches](file://patches)