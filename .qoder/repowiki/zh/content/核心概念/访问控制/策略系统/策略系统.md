# 策略系统

<cite>
**本文档中引用的文件**  
- [fixed-params-manager.ts](file://packages/core/acl/src/fixed-params-manager.ts)
- [snippet-manager.ts](file://packages/core/acl/src/snippet-manager.ts)
- [acl.ts](file://packages/core/acl/src/acl.ts)
- [acl-available-strategy.ts](file://packages/core/acl/src/acl-available-strategy.ts)
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts)
- [allow-manager.ts](file://packages/core/acl/src/allow-manager.ts)
- [server.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts)
</cite>

## 目录
1. [引言](#引言)
2. [策略概念与权限控制](#策略概念与权限控制)
3. [固定参数管理器](#固定参数管理器)
4. [代码片段管理器](#代码片段管理器)
5. [策略注册与管理流程](#策略注册与管理流程)
6. [策略执行流程](#策略执行流程)
7. [策略表达式语法与上下文变量](#策略表达式语法与上下文变量)
8. [策略缓存机制与性能影响](#策略缓存机制与性能影响)
9. [自定义策略的调试与测试](#自定义策略的调试与测试)
10. [结论](#结论)

## 引言

NocoBase 是一个灵活的低代码平台，其权限控制系统是保障数据安全的核心组件。策略系统作为权限控制的关键部分，允许开发者通过定义复杂的条件性逻辑来精确控制用户对资源的操作权限。本文档将深入探讨 NocoBase 策略系统的内部机制，涵盖策略的定义、注册、执行以及相关的管理工具，如固定参数管理器和代码片段管理器。通过本文档，读者将能够理解如何利用这些功能构建安全且高效的权限模型。

## 策略概念与权限控制

在 NocoBase 中，策略（Strategy）是一种用于定义角色（Role）对特定资源（Resource）和操作（Action）的访问权限的机制。策略的核心在于它能够实现复杂的条件性权限逻辑，而不仅仅是简单的允许或拒绝。例如，一个“成员”角色可能被赋予查看自己创建的记录的权限，这可以通过一个名为 `own` 的预定义策略来实现。

策略系统通过 `ACL` 类进行管理，该类负责处理所有与访问控制相关的逻辑。当一个请求到达时，系统会根据当前用户的当前角色（`currentRoles`）来确定其权限。`ACL` 类中的 `can` 方法用于检查某个角色是否被允许执行特定的资源操作。如果检查通过，系统会将相应的权限参数（如过滤条件、字段白名单等）合并到请求中，从而限制用户只能访问其被授权的数据。

策略的灵活性还体现在它可以与代码片段（Snippet）结合使用。代码片段是一组预定义的操作集合，可以被策略引用，从而简化权限配置。例如，一个代码片段可以包含对 UI 组件的所有操作权限，而另一个代码片段则可能限制对某些敏感模块的访问。

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L1-L603)
- [acl-available-strategy.ts](file://packages/core/acl/src/acl-available-strategy.ts#L1-L81)

## 固定参数管理器

固定参数管理器（FixedParamsManager）是 NocoBase 策略系统中的一个重要组件，它负责为特定的资源和操作添加固定的参数。这些参数在每次请求时都会被自动应用，无需用户手动指定。这在需要对某些操作施加全局限制时非常有用。

`FixedParamsManager` 类通过一个 `Map` 来存储每个资源-操作组合的参数合并器（Merger）。`addParams` 方法允许注册一个新的参数合并器，该合并器是一个返回对象的函数。当某个资源-操作被请求时，`getParams` 方法会调用所有相关的合并器，并将它们的结果合并成一个最终的参数对象。

参数的合并遵循特定的规则，例如：
- `filter` 参数使用 `andMerge` 规则，即多个过滤条件通过逻辑与（AND）连接。
- `fields` 参数使用 `intersect` 规则，即只保留所有请求字段的交集。
- `appends` 参数使用 `union` 规则，即合并所有附加字段。
- `sort` 参数使用 `overwrite` 规则，即后定义的排序规则覆盖先定义的。

这种设计确保了参数合并的可预测性和一致性，同时也提供了足够的灵活性来满足不同的业务需求。

**Section sources**
- [fixed-params-manager.ts](file://packages/core/acl/src/fixed-params-manager.ts#L1-L60)

## 代码片段管理器

代码片段管理器（SnippetManager）是 NocoBase 权限系统中用于组织和管理权限规则的工具。它允许将一组相关的操作权限打包成一个“代码片段”，然后在不同的角色或策略中复用。这种方式极大地简化了权限配置，特别是在面对复杂的应用场景时。

`SnippetManager` 类维护了一个 `Map`，其中键是代码片段的名称，值是 `Snippet` 对象。每个 `Snippet` 包含一个名称和一个操作数组。`register` 方法用于注册新的代码片段。在注册时，系统会检查代码片段名称的有效性，确保其不包含通配符 `*` 或以点号结尾。

代码片段的匹配使用 `minimatch` 库来实现，支持通配符模式。例如，一个代码片段可以定义为 `users:*`，表示对用户资源的所有操作。此外，代码片段名称前加 `!` 表示否定，即排除该代码片段中的所有操作。

在权限检查过程中，`allow` 方法会根据给定的操作路径和代码片段名称来判断是否允许该操作。如果代码片段存在且其操作数组中的任何一个与操作路径匹配，则返回 `true`；如果代码片段名称以 `!` 开头且匹配，则返回 `false`；否则返回 `null`，表示该代码片段不适用于当前操作。

**Section sources**
- [snippet-manager.ts](file://packages/core/acl/src/snippet-manager.ts#L1-L69)

## 策略注册与管理流程

NocoBase 的策略注册与管理流程是一个高度模块化和事件驱动的过程。整个流程始于插件的加载，特别是 `PluginACLServer` 插件的 `beforeLoad` 方法。在这个方法中，系统会注册各种代码片段、定义资源操作，并设置事件监听器来响应数据库的变化。

策略的注册主要通过 `registerSnippet` 方法完成。例如，在 `PluginACLServer` 的初始化过程中，会注册一个名为 `pm.${this.name}.roles` 的代码片段，该代码片段包含了对角色管理相关的所有操作权限。这些权限随后会被应用到具有相应角色的用户身上。

当数据库中的角色、资源或操作发生变化时，系统会触发相应的事件，如 `roles.afterSaveWithAssociations` 或 `collections.afterDestroy`。这些事件监听器会调用 `writeRoleToACL` 或 `writeResourceToACL` 方法，将最新的权限配置同步到 `ACL` 系统中。这个过程确保了权限数据的实时性和一致性。

此外，系统还提供了 `allow` 方法来直接允许某些操作，而无需通过角色和策略。例如，`this.app.acl.allow('*', '*', (ctx) => ctx.state.currentRoles?.includes('root'))` 这行代码表示，如果当前用户的角色列表中包含 `root`，则允许其执行任何操作。

**Section sources**
- [server.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts#L1-L685)
- [acl.ts](file://packages/core/acl/src/acl.ts#L460-L462)

## 策略执行流程

策略的执行流程是 NocoBase 权限控制的核心。当一个请求到达时，系统会通过一系列中间件来处理权限检查。这个流程始于 `getActionParams` 中间件，该中间件负责初始化权限上下文。

首先，系统会根据当前请求的资源名和操作名来确定目标资源。如果资源名包含点号（`.`），系统会提取最后一个部分作为实际的资源名。接着，系统会调用 `ctx.can` 方法来检查当前角色是否有权限执行该操作。这个方法会遍历所有相关角色，并调用 `can` 方法来获取权限结果。

如果权限检查通过，系统会将权限参数（`params`）与固定参数管理器中的参数进行合并。这个合并过程由 `mergeParams` 方法完成，它会根据预定义的规则来处理不同的参数类型。例如，`fields` 参数会被去重，`filter` 参数会被合并成一个逻辑与表达式。

最后，系统会将合并后的参数应用到请求的 `action` 对象上，从而限制用户只能访问其被授权的数据。如果权限检查失败，系统会抛出一个 `403` 错误，表示“无权限”。

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L423-L454)
- [acl.ts](file://packages/core/acl/src/acl.ts#L495-L573)

## 策略表达式语法与上下文变量

NocoBase 的策略表达式语法基于模板字符串，允许在权限规则中嵌入动态值。这些动态值通过上下文变量来提供，使得策略可以根据运行时的环境信息进行调整。

上下文变量通常以 `{{ }}` 的形式出现，例如 `{{ ctx.state.currentUser.id }}`。这些变量会在请求处理时被解析和替换。系统使用 `parseJsonTemplate` 方法来解析这些模板，该方法会递归地遍历 JSON 对象，并将所有匹配的模板字符串替换为相应的值。

可用的上下文变量包括但不限于：
- `ctx.state.currentUser`：当前登录用户的信息。
- `ctx.action`：当前请求的动作信息，包括资源名和操作名。
- `ctx.db`：数据库实例，可用于查询相关数据。

除了内置变量，开发者还可以通过 `VariablesProvider` 注册自定义变量。这些变量可以在策略表达式中使用，从而实现更复杂的权限逻辑。例如，可以根据用户的部门或职位来动态调整其权限范围。

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L519-L520)
- [VariablesProvider.tsx](file://packages/core/client/src/variables/VariablesProvider.tsx#L27-L357)

## 策略缓存机制与性能影响

为了提高性能，NocoBase 的策略系统采用了缓存机制。当用户的权限信息被查询后，系统会将其缓存起来，以便在后续请求中快速访问。这种缓存不仅减少了数据库查询的次数，还降低了系统的整体延迟。

缓存主要应用于两个方面：一是角色的权限配置，二是代码片段的解析结果。`ACLRole` 类中的 `_snippetCache` 属性就是一个典型的例子。它存储了当前角色的有效代码片段列表，避免了每次权限检查时都重新计算。

然而，缓存也带来了数据一致性的挑战。当权限配置发生变化时，必须及时清除相关的缓存，以确保用户能够立即获得最新的权限。为此，系统在关键的数据库事件（如 `roles.afterSaveWithAssociations`）上设置了监听器，这些监听器会在事件触发时自动清除缓存。

总体而言，合理的缓存策略能够在保证性能的同时，维持数据的准确性和实时性。

**Section sources**
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts#L37-L40)
- [server.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/server.ts#L342-L355)

## 自定义策略的调试与测试

调试和测试自定义策略是确保权限系统正确性的关键步骤。NocoBase 提供了多种工具和方法来帮助开发者完成这一任务。

首先，开发者可以通过日志来观察权限检查的过程。`ctx.log?.debug` 语句会在调试模式下输出详细的权限信息，包括原始参数、解析后的参数以及合并后的参数。这些信息对于诊断权限问题非常有帮助。

其次，系统提供了 `can` 方法的单元测试接口。开发者可以编写测试用例，模拟不同的用户角色和请求场景，验证策略是否按预期工作。例如，可以测试一个“成员”角色是否只能查看自己创建的记录。

此外，NocoBase 的前端界面也提供了权限管理的可视化工具。管理员可以通过图形界面来配置和测试策略，而无需直接编辑代码。这不仅降低了使用门槛，还提高了配置的准确性。

**Section sources**
- [acl.ts](file://packages/core/acl/src/acl.ts#L505-L506)
- [StrategyActions.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/permissions/StrategyActions.tsx#L45-L85)

## 结论

NocoBase 的策略系统是一个强大且灵活的权限控制框架，它通过策略、固定参数管理器和代码片段管理器等组件，实现了细粒度的访问控制。通过对策略的深入理解和合理运用，开发者可以构建出既安全又高效的权限模型，满足各种复杂的业务需求。同时，系统的缓存机制和调试工具也为性能优化和问题排查提供了有力支持。