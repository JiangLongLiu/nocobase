# 角色定义

<cite>
**本文档中引用的文件**  
- [roles.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/collections/roles.ts)
- [RoleModel.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/model/RoleModel.ts)
- [acl-role.ts](file://packages/core/acl/src/acl-role.ts)
- [role-collections.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/actions/role-collections.ts)
- [RoleModeSelect.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/RoleModeSelect.tsx)
- [setCurrentRole.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/middlewares/setCurrentRole.ts)
- [roles.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/schemas/roles.ts)
- [NewRole.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/NewRole.tsx)
</cite>

## 目录
1. [角色实体数据结构](#角色实体数据结构)
2. [角色管理API接口](#角色管理api接口)
3. [角色模式（Role Mode）](#角色模式role-mode)
4. [角色与数据库映射](#角色与数据库映射)
5. [代码示例](#代码示例)

## 角色实体数据结构

NocoBase中的角色实体定义了用户权限的核心结构。角色包含多个关键属性，用于标识角色的基本信息和权限配置。

角色实体的主要属性包括：
- **name**: 角色的唯一标识符（UID），作为主键使用，以"r_"为前缀
- **title**: 角色名称，支持多语言翻译，用于界面显示
- **description**: 角色描述，提供角色用途的说明
- **default**: 布尔值，标识是否为默认角色
- **hidden**: 布尔值，标识角色是否在界面中隐藏
- **allowConfigure**: 布尔值，标识角色是否允许配置
- **allowNewMenu**: 布尔值，标识是否允许创建新菜单
- **strategy**: JSON格式的策略配置，定义角色的权限策略
- **snippets**: 字符串集合，包含权限片段，支持通配符匹配
- **menuUiSchemas**: 与角色关联的UI模式
- **resources**: 角色拥有的资源权限集合

角色还通过关联关系与用户和资源建立联系：
- **users**: 多对多关系，关联拥有该角色的用户
- **resources**: 一对多关系，关联该角色的资源权限

**Section sources**
- [roles.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/collections/roles.ts#L24-L108)

## 角色管理API接口

NocoBase提供了完整的RESTful API接口用于角色的创建、更新和删除操作。这些接口遵循统一的资源操作模式，通过HTTP端点进行访问。

### 创建角色
- **端点**: `POST /roles:create`
- **请求体**: 包含角色属性的JSON对象
- **参数规范**: 
  - `title`: 角色名称（必填）
  - `name`: 角色UID（可选，系统自动生成）
  - `default`: 是否为默认角色
  - `description`: 角色描述

### 更新角色
- **端点**: `POST /roles:update`
- **查询参数**: `filterByTk` - 角色名称（必填）
- **请求体**: 包含要更新的属性的JSON对象
- **示例**: 更新角色描述和默认状态

### 删除角色
- **端点**: `POST /roles:destroy`
- **查询参数**: `filterByTk` - 角色名称（必填）
- **注意事项**: 删除角色前需确保没有用户关联该角色

### 获取角色列表
- **端点**: `GET /roles:list`
- **查询参数**: 
  - `page`: 页码
  - `pageSize`: 每页数量
  - `filter`: 过滤条件

### 检查当前角色
- **端点**: `GET /roles:check`
- **功能**: 返回当前用户的角色信息

**Section sources**
- [roles.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/collections/roles.ts#L12-L110)
- [index.ts](file://packages/plugins/@nocobase/plugin-acl/src/swagger/index.ts#L67-L153)

## 角色模式（Role Mode）

角色模式（Role Mode）是NocoBase中用于控制用户角色使用方式的重要机制。它定义了用户如何在多个角色之间进行切换和使用权限。

### 角色模式类型

NocoBase支持三种角色模式：

1. **独立角色模式（default）**
   - 用户需要在角色之间手动切换
   - 每次只能使用一个角色的权限
   - 适用于需要严格权限隔离的场景

2. **允许角色联合模式（allow-use-union）**
   - 用户可以选择使用角色联合
   - 可以同时使用所有角色的权限
   - 也可以切换到单个角色使用
   - 提供最大的灵活性

3. **仅角色联合模式（only-use-union）**
   - 强制用户使用角色联合
   - 自动合并所有角色的权限
   - 无法切换到单个角色
   - 适用于需要简化权限管理的场景

### 角色模式实现

角色模式通过中间件`setCurrentRole`实现，该中间件在每个请求中确定当前用户的角色状态：

- 通过`X-Role`请求头指定当前角色
- 从缓存中获取用户的角色列表
- 根据系统设置的角色模式决定最终的角色状态
- 支持匿名角色的特殊处理

当用户拥有多个角色时，系统会根据角色模式决定是使用联合角色还是单个角色。联合角色使用特殊的键`__union__`标识，系统会自动合并所有关联角色的权限。

**Section sources**
- [RoleModeSelect.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/RoleModeSelect.tsx#L16-L70)
- [setCurrentRole.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/middlewares/setCurrentRole.ts#L17-L105)
- [constants.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/constants.ts#L10)

## 角色与数据库映射

NocoBase的角色系统与数据库表结构有明确的映射关系，确保角色数据的持久化存储和高效检索。

### 主要数据库表

#### roles 表
- 存储角色的基本信息
- 主键为`name`字段
- 包含角色名称、描述、策略等属性
- 通过`snippets`字段存储权限片段集合

#### rolesResources 表
- 存储角色与资源的关联关系
- 复合主键：`roleName`和`name`
- `usingActionsConfig`字段标识是否使用独立的权限配置
- 与`roles`表通过`roleName`外键关联

#### rolesResourcesActions 表
- 存储角色资源的具体操作权限
- 与`rolesResources`表通过外键关联
- 定义特定资源上的具体操作权限

#### rolesUsers 表
- 存储用户与角色的多对多关系
- 包含`userId`和`roleName`外键
- `default`字段标识用户的默认角色

### 数据存储机制

角色数据的存储和检索通过以下机制实现：

1. **模型映射**: 使用`RoleModel`类将数据库记录映射到ACL系统
2. **缓存机制**: 使用Redis缓存用户角色信息，提高访问性能
3. **事务处理**: 确保角色相关数据的一致性更新
4. **索引优化**: 在关键字段上创建索引，提高查询效率

角色数据的写入通过`writeToAcl`方法实现，该方法将数据库中的角色配置同步到ACL系统中，确保权限系统的实时更新。

**Section sources**
- [roles.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/collections/roles.ts#L12-L110)
- [rolesResources.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/collections/rolesResources.ts#L12-L45)
- [RoleModel.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/model/RoleModel.ts#L13-L35)

## 代码示例

以下示例展示了如何通过服务端API定义新的角色类型。

### 创建新角色

```typescript
// 通过API创建新角色
const createRole = async () => {
  const roleData = {
    title: '自定义角色',
    name: 'custom_role',
    description: '这是一个自定义角色',
    default: false,
    snippets: ['!ui.*', '!pm', '!pm.*']
  };
  
  const response = await api.resource('roles').create({ values: roleData });
  return response.data;
};
```

### 配置角色权限

```typescript
// 配置角色对特定资源的权限
const configureRolePermissions = async (roleName: string) => {
  // 获取角色的资源列表
  const resources = await api.resource('roles.collections').list({
    associatedIndex: roleName
  });
  
  // 为特定资源配置独立权限
  await api.resource('rolesResources').update({
    filterByTk: `${roleName}.users`,
    values: {
      usingActionsConfig: true
    }
  });
};
```

### 设置系统角色模式

```typescript
// 设置系统的角色模式
const setSystemRoleMode = async (mode: 'default' | 'allow-use-union' | 'only-use-union') => {
  await api.resource('roles').setSystemRoleMode({
    values: { roleMode: mode }
  });
  
  // 需要刷新页面以应用新的角色模式
  window.location.reload();
};
```

### 角色权限检查

```typescript
// 检查当前用户的角色信息
const checkUserRole = async () => {
  const response = await api.resource('roles').check();
  return response.data;
};

// 检查特定操作的权限
const checkPermission = (actionPath: string): boolean | null => {
  const role = getCurrentRole();
  return role.snippetAllowed(actionPath);
};
```

这些代码示例展示了如何通过NocoBase的API接口进行角色的创建、配置和权限管理，为开发者提供了灵活的角色定义能力。

**Section sources**
- [NewRole.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/NewRole.tsx#L15-L102)
- [role-collections.ts](file://packages/plugins/@nocobase/plugin-acl/src/server/actions/role-collections.ts#L18-L105)
- [roles.tsx](file://packages/plugins/@nocobase/plugin-acl/src/client/schemas/roles.ts#L16-L246)