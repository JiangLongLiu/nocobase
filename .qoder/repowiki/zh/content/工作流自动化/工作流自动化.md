# 工作流自动化

<cite>
**本文档引用文件**   
- [Plugin.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Plugin.ts)
- [Processor.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Processor.ts)
- [WorkflowCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\WorkflowCanvas.tsx)
- [RequestInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-request\src\server\RequestInstruction.ts)
- [MailerInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-mailer\src\server\MailerInstruction.ts)
- [DelayInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-delay\src\server\DelayInstruction.ts)
- [LoopInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-loop\src\server\LoopInstruction.ts)
- [ParallelInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-parallel\src\server\ParallelInstruction.ts)
- [ExecutionPage.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionPage.tsx)
- [ExecutionCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionCanvas.tsx)
</cite>

## 目录
1. [工作流引擎架构](#工作流引擎架构)
2. [可视化工作流设计器](#可视化工作流设计器)
3. [内置动作节点](#内置动作节点)
4. [复杂流程控制](#复杂流程控制)
5. [工作流调试与监控](#工作流调试与监控)
6. [实际应用场景](#实际应用场景)

## 工作流引擎架构

NocoBase工作流引擎采用插件化架构设计，核心由触发器（Trigger）、动作节点（Node）和执行处理器（Processor）组成。工作流插件通过注册机制管理各种触发器和指令，实现灵活的流程控制。

工作流的执行由Processor类负责，它通过prepare方法准备执行环境，包括加载工作流定义、节点和作业。start方法启动工作流执行，resume方法用于恢复挂起的作业。Processor维护了节点和作业的映射关系，通过双链表结构组织节点，确保流程的正确执行顺序。

```mermaid
classDiagram
class WorkflowPlugin {
+instructions : Registry
+triggers : Registry
+enabledCache : Map
+getLogger(workflowId)
+isWorkflowSync(workflow)
+registerTrigger(type, trigger)
+registerInstruction(type, instruction)
+trigger(workflow, context, options)
+run(pending)
+resume(job)
+createProcessor(execution, options)
}
class Processor {
+execution : ExecutionModel
+options : ProcessorOptions
+logger : Logger
+transaction : Transaction
+mainTransaction : Transaction
+nodes : FlowNodeModel[]
+nodesMap : Map
+jobsMapByNodeKey : { [key : string] : JobModel }
+jobResultsMapByNodeKey : { [key : string] : any }
+jobsToSave : Map
+lastSavedJob : JobModel
+prepare()
+start()
+resume(job)
+exec(instruction, node, prevJob)
+run(node, input)
+end(node, job)
+recall(node, job)
+exit(s)
+saveJob(payload)
+getBranches(node)
+findBranchStartNode(node, parent)
+findBranchParentNode(node)
+findBranchEndNode(node)
+findBranchParentJob(job, node)
+findBranchLastJob(node, job)
+getScope(sourceNodeId, includeSelfScope)
+getParsedValue(value, sourceNodeId, options)
}
class Trigger {
<<abstract>>
+title : string
+description : string
+fieldset : object
+sync : boolean
+on(workflow)
+off(workflow)
+execute(workflow, values, options)
+validate(config)
}
class Instruction {
<<abstract>>
+run(node, prevJob, processor)
+resume(node, job, processor)
+getScope(node, result, processor)
+test(config)
}
WorkflowPlugin --> Processor : "创建"
WorkflowPlugin --> Trigger : "注册"
WorkflowPlugin --> Instruction : "注册"
Processor --> Instruction : "执行"
Processor --> JobModel : "管理"
Processor --> FlowNodeModel : "管理"
```

**图源**
- [Plugin.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Plugin.ts)
- [Processor.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Processor.ts)

**节源**
- [Plugin.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Plugin.ts#L1-L551)
- [Processor.ts](file://packages\plugins\@nocobase\plugin-workflow\src\server\Processor.ts#L1-L508)

## 可视化工作流设计器

NocoBase提供直观的可视化工作流设计器，用户可以通过拖拽方式创建和配置工作流。设计器界面包含工具栏、节点画布和属性面板，支持节点的添加、删除、连接和配置。

工作流设计器的核心组件是WorkflowCanvas，它使用FlowContext提供工作流数据和操作方法。用户可以通过ExecuteActionButton执行工作流，通过RevisionsDropdown切换不同版本。AddNodeContextProvider和RemoveNodeContextProvider分别管理节点的添加和删除操作。

```mermaid
flowchart TD
Start([打开工作流设计器]) --> Toolbar["工具栏"]
Toolbar --> Execute["执行按钮"]
Toolbar --> Revisions["版本下拉"]
Toolbar --> Switch["启用开关"]
Toolbar --> Menu["更多菜单"]
Execute --> Modal["执行确认模态框"]
Modal --> Form["表单"]
Form --> TriggerVars["触发器变量"]
Form --> AutoRevision["自动创建新版本"]
Form --> Confirm["确认执行"]
Revisions --> Load["加载版本列表"]
Load --> SwitchVersion["切换版本"]
Menu --> Refresh["刷新"]
Menu --> History["执行历史"]
Menu --> Copy["复制到新版本"]
Menu --> Delete["删除"]
Canvas["节点画布"] --> AddNode["添加节点"]
AddNode --> SelectType["选择节点类型"]
SelectType --> Configure["配置节点"]
Canvas --> Connect["连接节点"]
Connect --> Validate["验证连接"]
Canvas --> Edit["编辑节点"]
Edit --> Save["保存配置"]
Canvas --> DeleteNode["删除节点"]
DeleteNode --> ConfirmDelete["确认删除"]
```

**图源**
- [WorkflowCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\WorkflowCanvas.tsx)

**节源**
- [WorkflowCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\WorkflowCanvas.tsx#L1-L578)

## 内置动作节点

NocoBase提供了丰富的内置动作节点，包括数据操作、HTTP请求、邮件发送和延迟执行等。每个动作节点都是一个指令（Instruction）的实现，通过注册机制集成到工作流引擎中。

### HTTP请求节点

HTTP请求节点允许工作流向外部API发送HTTP请求。节点配置包括URL、方法、参数、请求头和请求体。支持同步和异步执行模式，异步模式下请求会挂起工作流，等待响应后再继续执行。

```mermaid
sequenceDiagram
participant WF as 工作流引擎
participant Node as HTTP请求节点
participant HTTP as HTTP客户端
participant API as 外部API
WF->>Node : 执行节点
Node->>HTTP : 发送请求
HTTP->>API : HTTP请求
API-->>HTTP : HTTP响应
HTTP-->>Node : 返回响应
alt 同步模式
Node-->>WF : 返回结果
else 异步模式
Node->>WF : 挂起工作流
Node->>HTTP : 等待响应
HTTP-->>Node : 获取响应
Node->>WF : 恢复工作流
WF->>Node : 继续执行
end
```

**图源**
- [RequestInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-request\src\server\RequestInstruction.ts)

**节源**
- [RequestInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-request\src\server\RequestInstruction.ts#L1-L250)

### 邮件发送节点

邮件发送节点通过SMTP协议发送电子邮件。节点配置包括收件人、抄送、密送、主题、内容和邮件服务器设置。支持HTML和纯文本格式，可以配置是否忽略发送失败。

```mermaid
sequenceDiagram
participant WF as 工作流引擎
participant Node as 邮件节点
participant Mailer as 邮件客户端
participant SMTP as SMTP服务器
WF->>Node : 执行节点
Node->>Mailer : 创建邮件
Mailer->>SMTP : 连接服务器
SMTP-->>Mailer : 连接成功
Mailer->>SMTP : 发送邮件
alt 发送成功
SMTP-->>Mailer : 发送成功
Mailer-->>Node : 返回成功
Node-->>WF : 返回结果
else 发送失败
SMTP-->>Mailer : 发送失败
Mailer-->>Node : 返回错误
alt 忽略失败
Node-->>WF : 返回成功
else 不忽略失败
Node-->>WF : 返回失败
end
end
```

**图源**
- [MailerInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-mailer\src\server\MailerInstruction.ts)

**节源**
- [MailerInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-mailer\src\server\MailerInstruction.ts#L1-L171)

### 延迟执行节点

延迟执行节点用于在指定时间后继续执行工作流。节点配置包括延迟时间和结束状态。延迟期间工作流处于挂起状态，不会占用系统资源。

```mermaid
flowchart TD
Start([开始]) --> Configure["配置延迟时间"]
Configure --> SaveJob["保存作业"]
SaveJob --> Exit["退出处理器"]
Exit --> Wait["等待延迟时间"]
Wait --> Resume["恢复作业"]
Resume --> CheckStatus["检查结束状态"]
CheckStatus --> |已完成| End1([结束])
CheckStatus --> |挂起| End2([继续挂起])
```

**图源**
- [DelayInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-delay\src\server\DelayInstruction.ts)

**节源**
- [DelayInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-delay\src\server\DelayInstruction.ts#L1-L54)

## 复杂流程控制

NocoBase工作流支持条件分支、并行执行和循环等复杂流程控制机制，通过特定的节点类型实现。

### 条件分支

条件分支节点根据表达式的结果决定执行路径。支持多种计算引擎和表达式语法，可以基于上下文数据进行复杂判断。

```mermaid
flowchart TD
Start([条件分支节点]) --> Evaluate["计算条件表达式"]
Evaluate --> Result{"结果"}
Result --> |真| Branch1["分支1"]
Result --> |假| Branch2["分支2"]
Branch1 --> End1([结束])
Branch2 --> End2([结束])
```

### 并行执行

并行执行节点同时执行多个分支，支持多种完成模式：全部完成、任一完成或全部已决。

```mermaid
flowchart TD
Start([并行节点]) --> Fork["分叉"]
Fork --> Branch1["分支1"]
Fork --> Branch2["分支2"]
Fork --> Branch3["分支3"]
Branch1 --> Join["合并"]
Branch2 --> Join
Branch3 --> Join
Join --> Mode{"完成模式"}
Mode --> |全部完成| All["等待所有分支完成"]
Mode --> |任一完成| Race["任一分支完成即继续"]
Mode --> |全部已决| Settled["等待所有分支已决"]
All --> End1([结束])
Race --> End2([结束])
Settled --> End3([结束])
```

**图源**
- [ParallelInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-parallel\src\server\ParallelInstruction.ts)

**节源**
- [ParallelInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-parallel\src\server\ParallelInstruction.ts#L40-L84)

### 循环

循环节点重复执行内部分支，支持基于目标长度或条件表达式的循环。

```mermaid
flowchart TD
Start([循环节点]) --> Init["初始化"]
Init --> CheckTarget["检查目标"]
CheckTarget --> |无目标| End1([结束])
CheckTarget --> |有目标| Loop["循环"]
Loop --> Condition["检查条件"]
Condition --> |满足| Execute["执行分支"]
Condition --> |不满足| Break["跳出循环"]
Execute --> Increment["递增计数"]
Increment --> CheckLimit["检查循环限制"]
CheckLimit --> |未超限| Loop
CheckLimit --> |超限| Error["超出限制"]
Break --> End2([结束])
Error --> End3([结束])
```

**图源**
- [LoopInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-loop\src\server\LoopInstruction.ts)

**节源**
- [LoopInstruction.ts](file://packages\plugins\@nocobase\plugin-workflow-loop\src\server\LoopInstruction.ts#L1-L215)

## 工作流调试与监控

NocoBase提供完善的工作流调试和监控工具，帮助用户查看执行日志和跟踪状态。

### 执行历史

执行历史页面显示工作流的所有执行记录，包括触发时间、状态和结果。用户可以查看详细执行日志，了解每个节点的执行情况。

```mermaid
flowchart TD
Start([执行历史页面]) --> Load["加载执行列表"]
Load --> Filter["过滤执行记录"]
Filter --> Sort["排序执行记录"]
Sort --> Display["显示执行列表"]
Display --> Select["选择执行记录"]
Select --> ViewDetail["查看执行详情"]
ViewDetail --> ShowNodes["显示节点执行状态"]
ShowNodes --> ShowLogs["显示执行日志"]
ShowLogs --> Analyze["分析执行过程"]
```

**图源**
- [ExecutionPage.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionPage.tsx)
- [ExecutionCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionCanvas.tsx)

**节源**
- [ExecutionPage.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionPage.tsx#L1-L40)
- [ExecutionCanvas.tsx](file://packages\plugins\@nocobase\plugin-workflow\src\client\ExecutionCanvas.tsx#L284-L334)

### 状态跟踪

工作流执行过程中，系统会实时更新执行状态，包括待处理、进行中、已完成、失败等。用户可以通过状态指示器快速了解工作流的执行情况。

```mermaid
stateDiagram-v2
[*] --> Pending : 创建执行
Pending --> Started : 开始执行
Started --> Resolved : 成功完成
Started --> Failed : 执行失败
Started --> Error : 发生错误
Started --> Aborted : 被中止
Started --> Canceled : 被取消
Started --> Rejected : 被拒绝
Started --> RetryNeeded : 需要重试
Resolved --> [*]
Failed --> [*]
Error --> [*]
Aborted --> [*]
Canceled --> [*]
Rejected --> [*]
RetryNeeded --> Started
```

## 实际应用场景

NocoBase工作流可以应用于多种实际场景，如审批流程、数据同步和事件响应。

### 审批流程

审批流程是工作流的典型应用场景，通过条件分支和手动节点实现多级审批。

```mermaid
flowchart TD
Start([提交申请]) --> CheckAmount["检查金额"]
CheckAmount --> |小于1000| AutoApprove["自动批准"]
CheckAmount --> |大于等于1000| ManagerApprove["经理审批"]
ManagerApprove --> |批准| DeptHeadApprove["部门主管审批"]
ManagerApprove --> |拒绝| Reject["拒绝"]
DeptHeadApprove --> |批准| FinanceApprove["财务审批"]
DeptHeadApprove --> |拒绝| Reject
FinanceApprove --> |批准| Approved["批准"]
FinanceApprove --> |拒绝| Reject
AutoApprove --> Approved
Reject --> End1([结束])
Approved --> End2([结束])
```

### 数据同步

数据同步场景通过定时触发器和HTTP请求节点实现系统间的数据同步。

```mermaid
flowchart TD
Start([定时触发]) --> Extract["提取数据"]
Extract --> Transform["转换数据"]
Transform --> Load["加载数据"]
Load --> API["调用目标系统API"]
API --> |成功| Success["同步成功"]
API --> |失败| Retry["重试"]
Retry --> |重试成功| Success
Retry --> |重试失败| Fail["同步失败"]
Success --> End1([结束])
Fail --> End2([结束])
```

### 事件响应

事件响应场景通过集合事件触发器监听数据变化，并执行相应的响应动作。

```mermaid
flowchart TD
Start([数据变更]) --> Trigger["触发工作流"]
Trigger --> CheckStatus["检查状态"]
CheckStatus --> |新创建| SendEmail["发送通知邮件"]
CheckStatus --> |已关闭| CreateTask["创建后续任务"]
CheckStatus --> |已解决| UpdateRecord["更新相关记录"]
SendEmail --> End1([结束])
CreateTask --> End2([结束])
UpdateRecord --> End3([结束])
```