# 使用源码开发模式

本文档介绍如何使用源码开发模式进行 NocoBase 的二次开发、插件开发和深度定制。

## 为什么选择源码开发模式？

相比官方镜像部署，源码开发模式有以下优势：

### 1. 更适合二次开发和调试
- 可以直接在本地用 IDE（VS Code / WebStorm）打开整个源码仓库
- 支持代码跳转、重构、全局搜索
- 完整的 TypeScript 类型提示
- 可以设置断点进行前端和后端调试
- 使用 `yarn dev` 支持热更新，修改代码后几乎实时看到效果

### 2. 与官方开发流程完全对齐
项目内置了完整的开发脚本（`package.json`）：
- `yarn dev` - 本地开发模式
- `yarn dev-server` - 仅启动后端
- `yarn build` + `yarn start` - 构建和生产模式
- `yarn test:*` - 运行测试

使用源码模式，就是在官方推荐的开发环境下工作，后续跟进升级、调试插件、编写测试都会更顺畅。

### 3. 插件开发和深度定制
如果需要以下功能，源码模式几乎是必选：
- 开发自定义插件（服务端/客户端）
- 修改内置插件行为
- 改动核心逻辑（权限、数据建模、工作流等）
- 本地快速试验新特性、调试 SDK、编写脚本

镜像模式更偏向"黑盒运行"，源码模式则是"完全掌握代码"，适合真正做产品和二次开发。

### 4. 更细粒度的环境控制
- 完全控制 Node.js 版本（项目要求 Node ≥ 18）
- 精确控制依赖版本：`package.json` + `yarn.lock`
- 可以直接在源码中添加日志、修改依赖版本来排查问题
- 在纯 Docker 镜像模式下这些操作会比较困难

### 5. 与 Git 流程无缝集成
- 本地就是标准的 Git 仓库，支持分支管理、提交、回滚
- 可以进行 Code Review
- 干净地管理自己的改动、插件源码、配置等

### 6. 更好的开发体验
- `yarn dev` 启动时前端支持热更新、快速增量构建（Vite/Webpack）
- 适合频繁修改 UI、调试交互的场景
- 不需要每次都打包镜像、重启容器

---

**简单总结**：
- **只是使用 NocoBase**：推荐官方镜像部署
- **需要二次开发/深度定制**：推荐源码开发模式

---

## Git 版本管理最佳实践

针对后续跟进官方升级、调试插件、写测试、插件开发和深度定制的场景，推荐以下 Git 工作流。

### 1. 仓库布局与远程配置

**推荐：Fork 官方仓库 + 本地多远程**

#### 步骤 1：Fork 官方仓库

在 GitHub 上 fork `nocobase/nocobase` 到你自己的账号。

#### 步骤 2：克隆你的 Fork

```bash
git clone https://github.com/你的账号/nocobase.git
cd nocobase
```

#### 步骤 3：添加官方仓库为 upstream

```bash
git remote add upstream https://github.com/nocobase/nocobase.git
git fetch upstream
```

#### 步骤 4：验证远程仓库配置

```bash
git remote -v
```

应该看到：
```
origin    https://github.com/你的账号/nocobase.git (fetch)
origin    https://github.com/你的账号/nocobase.git (push)
upstream  https://github.com/nocobase/nocobase.git (fetch)
upstream  https://github.com/nocobase/nocobase.git (push)
```

**远程仓库说明**：
- `origin`：你的 fork（你推送的地方）
- `upstream`：官方仓库（只拉不推，用于同步官方更新）

---

### 2. 分支策略：主线干净，改动集中在特性分支

**强烈建议：不要在 `main` 上直接开发。**

#### 推荐的分支模型

- `upstream/main`：官方主线，用于同步官方更新
- `origin/main`：你的 fork 主线，保持和 `upstream/main` 尽量一致（只做 fast-forward 合并）
- 你自己的开发分支：
  - `feature/plugin-xxx`：某个插件开发
  - `feature/custom-acl`：某个深度定制
  - `feature/tests-xxx`：针对某模块补测试
  - `debug/xxx`：临时调试分支

#### 典型操作流程

```bash
# 同步官方最新代码
git fetch upstream
git checkout main
git merge --ff-only upstream/main   # 或 git reset --hard upstream/main
git push origin main

# 基于最新 main 开新分支做开发
git checkout -b feature/plugin-approval
# 开发中...
git add .
git commit -m "feat(plugin-approval): add approval workflow"

# 推送到自己的仓库
git push origin feature/plugin-approval
```

**好处**：
- `main` 永远是"官方 + 已发布版本"的干净分支，升级时不会一堆冲突
- 你的改动集中在 feature 分支上，出问题时可以快速比对、回滚

---

### 3. 跟进官方升级的推荐流程

当官方有新版本时，推荐用 **"先同步 main，再更新你的特性分支"** 的方式。

#### 步骤 1：同步官方 main

```bash
git fetch upstream
git checkout main
git merge --ff-only upstream/main   # 或者 git reset --hard upstream/main
git push origin main                # 可选：同步到你自己的 fork
```

#### 步骤 2：更新你的开发/定制分支

对每一个有长期维护价值的分支（例如 `feature/my-customizations`）：

**方式 A：rebase（历史干净，推荐）**

```bash
git checkout feature/my-customizations
git rebase main   # 把你的改动"重放"到最新官方 main 上
# 按提示解决冲突，解决完每一步：
# git add .
# git rebase --continue
git push -f origin feature/my-customizations
```

**方式 B：merge（操作更简单，历史有分叉）**

```bash
git checkout feature/my-customizations
git merge main
# 解决冲突后
git add .
git commit
git push origin feature/my-customizations
```

**建议**：
- 如果你主要自己用，且分支不太多，**rebase 更清爽**，合并历史干净
- 如果多人协作、大家对 rebase 不熟，可以用 merge，但记得保持 main 始终干净

---

### 4. 插件开发 & 深度定制的 Git 组织方式

#### 4.1 插件优先放在插件目录

自定义插件尽量放在 `packages/plugins` 下的**自有命名空间**目录，比如：

```
packages/plugins/@your-org/my-workflow
packages/plugins/@your-org/custom-approval
packages/plugins/@your-org/advanced-report
```

每个插件独立一个目录、独立 package.json（如果需要），方便：
- 单独调试
- 单独写测试
- 将来抽离成独立仓库或 npm 包

**Git 层面的好处**：  
插件代码基本都在固定目录里，和官方代码冲突少，升级时主要关注少量真正改 core 的地方。

#### 4.2 深度定制 core 时的建议

不可避免要改 core 时，建议：

1. **分开提交**：
   ```bash
   # 提交 1：纯插件代码/配置
   git commit -m "feat(plugin-approval): add custom workflow plugin"
   
   # 提交 2：修改 core 某个模块
   git commit -m "feat(core): support custom workflow hook for plugin approval"
   ```

2. **提交信息写清楚**：
   - 使用 [约定式提交](https://www.conventionalcommits.org/zh-hans/)
   - 如 `feat(core): support custom workflow hook for plugin xxx`
   - 如 `fix(acl): allow custom permission check logic`

3. **尽量用可配置/可扩展点实现**，不要直接改业务逻辑：
   - 新增 hook / 配置项 / 中间件链路
   - 尽量不直接硬改内部实现

**好处**：
- 将来升级时，一眼能看出哪些地方是"自己改过官方代码"的
- 冲突只集中在少数几个 commit 上

---

### 5. 调试插件、写测试时的 Git 使用建议

#### 5.1 为"实验性调试"开临时分支

调试时常常会加很多 log / 临时代码，推荐：

```bash
git checkout -b debug/plugin-approval-bug-123
# 各种 log / 临时改动
git commit -m "chore(debug): add logs for approval bug 123"
```

调试结束后：
- 把真正有价值的修改挑出来 `cherry-pick` / 重写干净 commit 到 `feature/plugin-approval`
- `debug/*` 分支可以随时删除

```bash
# 切回功能分支
git checkout feature/plugin-approval

# 挑选有价值的提交
git cherry-pick <commit-hash>

# 删除调试分支
git branch -D debug/plugin-approval-bug-123
```

#### 5.2 测试相关的分支/提交习惯

- 对插件写测试：和插件目录放一起，例如：
  ```
  packages/plugins/@your-org/my-workflow/__tests__/*.test.ts
  ```

- Git 建议：
  - 写测试时也可以开独立分支 `feature/plugin-xxx-tests`
  - 合并时保持一个清晰的提交，例如：
    ```bash
    git commit -m "test(plugin-my-workflow): cover edge cases of approval process"
    ```

---

### 6. 推荐的日常工作流（示例）

结合本地 Docker Compose + 源码开发 + 插件 & 深度定制的场景：

#### 每天/每周同步官方

```bash
git fetch upstream
git checkout main
git merge --ff-only upstream/main
git push origin main
```

#### 开始一个新插件 / 新定制

```bash
git checkout main
git checkout -b feature/plugin-approval-flow

# 在 packages/plugins/@your-org/approval-flow 下开发
mkdir -p packages/plugins/@your-org/approval-flow
cd packages/plugins/@your-org/approval-flow
# 开发...

git add .
git commit -m "feat(plugin-approval-flow): initial version"
git push origin feature/plugin-approval-flow
```

#### 需要深度调试某个问题

```bash
git checkout feature/plugin-approval-flow
git checkout -b debug/approval-bug-123

# 加日志、调试...
git commit -m "chore(debug): add logs for approval bug 123"

# 调试结束后，把真正修复的那一部分改干净，提交回 feature 分支
git checkout feature/plugin-approval-flow
git cherry-pick <fix-commit-hash>
git push origin feature/plugin-approval-flow

# 删除调试分支
git branch -D debug/approval-bug-123
```

#### 官方发布新版本，你要跟进

```bash
# 同步官方
git fetch upstream
git checkout main
git merge --ff-only upstream/main
git push origin main

# 更新你的功能分支
git checkout feature/plugin-approval-flow
git rebase main   # 或 git merge main
# 解决冲突 + 跑测试
yarn install
yarn build
yarn test

git push -f origin feature/plugin-approval-flow
```

---

## 分支命名规范建议

为了更好地管理分支，推荐以下命名规范：

| 分支类型 | 命名格式 | 示例 | 说明 |
|---------|---------|------|------|
| 主分支 | `main` | `main` | 同步官方主线 |
| 功能开发 | `feature/<name>` | `feature/plugin-approval` | 新功能或插件开发 |
| 深度定制 | `feature/custom-<name>` | `feature/custom-acl` | 对核心功能的定制 |
| 测试补充 | `feature/tests-<name>` | `feature/tests-workflow` | 补充测试用例 |
| 调试分支 | `debug/<issue>` | `debug/approval-bug-123` | 临时调试，用完即删 |
| 修复分支 | `fix/<issue>` | `fix/permission-check` | Bug 修复 |

---

## 提交信息规范

建议使用 [约定式提交](https://www.conventionalcommits.org/zh-hans/) 规范：

```
<类型>(<范围>): <简短描述>

[可选的正文]

[可选的脚注]
```

### 常用类型

- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档变更
- `style`: 代码格式（不影响代码运行的变动）
- `refactor`: 重构（既不是新增功能，也不是修复 bug）
- `perf`: 性能优化
- `test`: 添加测试
- `chore`: 构建过程或辅助工具的变动

### 示例

```bash
# 新功能
git commit -m "feat(plugin-approval): add multi-level approval workflow"

# Bug 修复
git commit -m "fix(acl): resolve permission check for custom resources"

# 测试
git commit -m "test(workflow): add edge case tests for approval process"

# 调试（临时）
git commit -m "chore(debug): add detailed logs for workflow execution"

# 文档
git commit -m "docs(plugin): update approval workflow documentation"
```

---

## 环境配置

使用源码开发模式前，请确保环境符合要求：

### 系统要求

- **Node.js**: ≥ 18
- **Yarn**: 推荐使用 Yarn 1.x
- **数据库**: PostgreSQL / MySQL / MariaDB / SQLite
- **Docker**: 用于运行数据库服务

### 配置步骤

1. **复制环境变量文件**：
   ```bash
   cp .env.example .env
   ```

2. **修改 `.env` 配置**：
   ```bash
   # 应用配置
   APP_ENV=development
   APP_PORT=13000
   APP_KEY=your-secret-key  # 修改为你自己的密钥
   
   # 数据库配置（选择一种）
   DB_DIALECT=postgres       # postgres | mysql | mariadb
   DB_HOST=localhost
   DB_PORT=5432              # PostgreSQL: 5432, MySQL: 3306
   DB_DATABASE=nocobase
   DB_USER=nocobase
   DB_PASSWORD=nocobase
   
   # 初始化配置
   INIT_LANG=zh-CN
   INIT_ROOT_EMAIL=admin@nocobase.com
   INIT_ROOT_PASSWORD=admin123
   INIT_ROOT_NICKNAME=超级管理员
   ```

3. **启动数据库服务**：
   ```bash
   # 启动 PostgreSQL
   docker-compose up -d postgres
   
   # 或启动 MySQL
   docker-compose up -d mysql
   ```

4. **安装依赖并启动**：
   ```bash
   # 安装依赖
   yarn install
   
   # 启动开发服务器
   yarn dev
   
   # 或构建后启动生产模式
   yarn build
   yarn start
   ```

5. **访问应用**：
   打开浏览器访问 `http://localhost:13000`

---

## 常用开发命令

```bash
# 开发模式（支持热更新）
yarn dev

# 仅启动后端
yarn dev-server

# 构建生产版本
yarn build

# 启动生产模式
yarn start

# 运行测试
yarn test

# 运行服务端测试
yarn test:server

# 运行客户端测试
yarn test:client

# 插件管理
yarn pm

# 查看帮助
yarn nocobase -h

# 安装 NocoBase
yarn nocobase install

# 升级 NocoBase
yarn nocobase upgrade
```

---

## 总结

使用源码开发模式的关键要点：

1. **Fork 官方仓库**，添加 upstream 远程仓库用于同步官方更新
2. **保持 main 分支干净**，所有开发都在 feature 分支进行
3. **插件放在独立目录**，方便管理和维护
4. **定期同步官方更新**，使用 rebase 或 merge 保持分支最新
5. **使用规范的提交信息**，方便追溯和管理
6. **临时调试用 debug 分支**，调试完删除或挑选有价值的提交

这套工作流能够确保：
- ✅ 轻松跟进官方升级
- ✅ 清晰管理自定义改动
- ✅ 方便插件开发和测试
- ✅ 降低版本冲突风险
- ✅ 提高代码可维护性

---

**最后更新**: 2025-12-26
